<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·ä¹‹è©¦ç…‰ï¼šé›»åŠ›ç”Ÿå­˜æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .card-category-high { border-left: 4px solid #EF4444; /* red-500 */ }
        .card-category-medium { border-left: 4px solid #F59E0B; /* amber-500 */ }
        .card-category-low { border-left: 4px solid #22C55E; /* green-500 */ }

        .energy-block {
            transition: all 0.3s ease;
        }
        .energy-block.full {
            background-color: #22C55E; /* green-500 */
            box-shadow: 0 0 10px 0 #22C55E80;
        }
        .energy-block.empty {
            background-color: #374151; /* gray-700 */
        }

        /* ç”Ÿå­˜æ•¸å€¼æ¢æ¨£å¼ */
        .survival-bar-bg {
            background-color: #374151; /* gray-700 */
        }
        .survival-bar-fill {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .survival-bar-fill.red { background-color: #EF4444; }
        .survival-bar-fill.yellow { background-color: #F59E0B; }
        .survival-bar-fill.green { background-color: #22C55E; }
        .survival-bar-fill.blue { background-color: #3B82F6; }
        .survival-bar-fill.purple { background-color: #8B5CF6; } /* å¿ƒæƒ… */
        .survival-bar-fill.cyan { background-color: #06B6D4; } /* æ‰‹æ©Ÿ */

        /* ç¢ºä¿æµ®å‹•æ¨™é ­å’ŒæŒ‰éˆ•ä¸‹çš„å…§å®¹ä¸æœƒè¢«é®æ“‹ */
        #game-screen {
            padding-top: 170px; /* æµ®å‹•æ¨™é ­çš„é«˜åº¦ */
            padding-bottom: 100px; /* æµ®å‹•æŒ‰éˆ•çš„é«˜åº¦ */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div id="app-container" class="max-w-xl mx-auto">

        <!-- ç•«é¢ 1: æƒ…å¢ƒä»‹ç´¹ -->
        <div id="intro-screen" class="flex flex-col items-center justify-center min-h-[90vh] text-center">
            <header class="mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-4">â® é›·ä¹‹å‘¼å¸ï¼šé›»åŠ›ç”Ÿå­˜æŒ‘æˆ° â¯</h1>
                <p class="text-xl md:text-2xl text-gray-300">è“„é›»æ± ä¸æ˜¯ç„¡é™çš„ï¼</p>
            </header>
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full">
                <p class="text-lg font-bold mb-4">(åš´è‚…åœ°) è©¦ç…‰é–‹å§‹ï¼</p>
                <p class="text-base text-gray-300 mb-4">
                    é–‹æˆ°ç¬¬ä¸ƒå¤©ï¼Œå¯’æµä¾†è¥²ï¼Œå®¤å¤– 9Â°Cã€‚ç³§é£Ÿå’Œæ°´é‚„å¤ ï¼Œä½†å·²æ–·é›»ã€‚
                    å¹¸å¥½ï¼Œä½ çš„è“„é›»æ± å……é£½äº† <span class="text-green-400 font-bold">10 æ ¼é›»</span>ã€‚
                </p>
                <p class="text-base text-gray-300 mb-6">
                    ç¾åœ¨æ˜¯æ—©ä¸Š 7:00ï¼Œä½ å‰›èµ·åºŠã€‚ä»Šå¤©è¦æ€éº¼åˆ†é…é›»é‡å¥½å‘¢ï¼Ÿ
                </p>
                <button id="start-button" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition duration-300">
                    é–‹å§‹æŒ‘æˆ° (07:00)
                </button>
            </div>
        </div>

        <!-- ç•«é¢ 2: éŠæˆ²ä¸»é«” -->
        <div id="game-screen" class="hidden">
            
            <!-- V7: æµ®å‹•ç‹€æ…‹åˆ— (é ‚éƒ¨) -->
            <div id="sticky-header" class="fixed top-0 left-0 right-0 bg-gray-900 shadow-lg z-20 max-w-xl mx-auto p-4 border-b border-gray-700">
                <!-- ç”Ÿå­˜æ•¸å€¼é¡¯ç¤º -->
                <div id="survival-stats" class="grid grid-cols-2 gap-3 mb-4">
                    <div class="flex items-center space-x-2">
                        <span class="text-red-400 font-bold w-16">é£½è¶³åº¦:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-4">
                            <div id="bar-fullness" class="survival-bar-fill red rounded-full" style="width: 50%;"></div>
                        </div>
                        <span id="val-fullness" class="w-10 text-right">50%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-blue-400 font-bold w-16">å¥åº·:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-4">
                            <div id="bar-health" class="survival-bar-fill blue rounded-full" style="width: 70%;"></div>
                        </div>
                        <span id="val-health" class="w-10 text-right">70%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-purple-400 font-bold w-16">å¿ƒæƒ…:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-4">
                            <div id="bar-mood" class="survival-bar-fill purple rounded-full" style="width: 50%;"></div>
                        </div>
                        <span id="val-mood" class="w-10 text-right">50%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-cyan-400 font-bold w-16">æ‰‹æ©Ÿ:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-4">
                            <div id="bar-phone" class="survival-bar-fill cyan rounded-full" style="width: 0%;"></div>
                        </div>
                        <span id="val-phone" class="w-10 text-right">0%</span>
                    </div>
                </div>

                <!-- é›»åŠ›å­˜é‡ -->
                <div class="bg-gray-800 p-3 rounded-lg shadow-md">
                    <h2 class="text-lg font-bold mb-2 text-center">è“„é›»æ± å­˜é‡</h2>
                    <div id="energy-display" class="grid grid-cols-10 gap-1.5 mb-2">
                        <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆ 10 æ ¼é›» -->
                    </div>
                    <div class="text-center text-lg font-bold">
                        å‰©é¤˜é›»åŠ›ï¼š <span id="energy-count" class="text-green-400 text-2xl">10</span> / 10
                    </div>
                </div>
            </div>

            <!-- éŠæˆ²ä¸»è¦å…§å®¹ (å¯æ²å‹•) -->
            <main class="w-full">
                <!-- æ™‚æ®µæ¨™é¡Œ -->
                <header class="text-center mb-4">
                    <h1 id="phase-title" class="text-3xl font-bold text-yellow-400"></h1>
                </header>

                <!-- æƒ…å¢ƒå ±å‘Š -->
                <div id="scenario-report" class="p-4 rounded-lg mb-6 shadow-lg text-base bg-gray-800 border-l-4 border-yellow-400 min-h-[50px]">
                    <!-- JS æœƒåœ¨é€™è£¡æ’å…¥æƒ…å¢ƒå ±å‘Š -->
                </div>

                <!-- é›»å™¨å¡ç‰‡å€ -->
                <div id="appliance-list" class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-300 mb-4 text-center">é¸æ“‡ä½ è¦ä½¿ç”¨çš„é›»å™¨ï¼š</h2>
                    
                    <!-- é«˜è€—èƒ½ -->
                    <section>
                        <h3 class="text-xl font-bold text-red-500 mb-3 flex items-center">
                            <span class="text-2xl mr-2">ğŸ‘¹</span> æ¯€æ»…ç´š (é«˜è€—èƒ½)
                        </h3>
                        <div id="high-energy-list" class="grid grid-cols-1 gap-4">
                            <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆå¡ç‰‡ -->
                        </div>
                    </section>
                    
                    <!-- ä¸­è€—èƒ½ -->
                    <section>
                        <h3 class="text-xl font-bold text-amber-500 mb-3 flex items-center">
                            <span class="text-2xl mr-2">ğŸŸ¡</span> æˆ°è¡“ç´š (ä¸­è€—èƒ½)
                        </h3>
                        <div id="medium-energy-list" class="grid grid-cols-1 gap-4">
                            <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆå¡ç‰‡ -->
                        </div>
                    </section>

                    <!-- ä½è€—èƒ½ -->
                    <section>
                        <h3 class="text-xl font-bold text-green-500 mb-3 flex items-center">
                            <span class="text-2xl mr-2">ğŸ’š</span> ç¶­ç”Ÿç´š (ä½è€—èƒ½)
                        </h3>
                        <div id="low-energy-list" class="grid grid-cols-1 gap-4">
                            <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆå¡ç‰‡ -->
                        </div>
                    </section>
                </div>
            </main>

            <!-- V6: æµ®å‹•æ¨é€²æŒ‰éˆ• (åº•éƒ¨) -->
            <button id="proceed-button" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition duration-300 mt-8 fixed bottom-0 left-0 right-0 z-20 max-w-xl mx-auto opacity-95">
                æ¨é€²åˆ° ä¸­åˆ (12:00)
            </button>
        </div>

        <!-- ç•«é¢ 3: ç¸½çµå ±å‘Š -->
        <div id="conclusion-screen" class="hidden flex flex-col items-center justify-center min-h-[90vh] text-center">

            <!-- V8-Fix: èª¿æ•´é †åºï¼Œå…ˆé¡¯ç¤ºåŠ‡æƒ…å›é¥‹ (ç§»åˆ° header ä¸Šæ–¹) -->
            <div id="conclusion-feedback" class="text-lg mb-8 p-4 bg-gray-700 rounded-md text-left w-full">
                <!-- JS æœƒæ’å…¥å‹•æ…‹åé¥‹ -->
            </div>

            <header class="mb-8">
                <h1 id="conclusion-title" class="text-3xl md:text-4xl font-bold text-yellow-400 mb-4">â® è©¦ç…‰ç¸½çµ â¯</h1>
            </header>
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full">
                <p id="conclusion-stats" class="text-lg text-gray-300 mb-6"></p>
                
                <div class="text-left text-base bg-gray-900 p-4 rounded-md mb-6 space-y-2">
                    <p><span class="text-red-400 font-bold">æœ€çµ‚é£½è¶³åº¦:</span> <span id="final-fullness"></span>%</p>
                    <p><span class="text-blue-400 font-bold">æœ€çµ‚å¥åº·:</span> <span id="final-health"></span>%</p>
                    <p><span class="text-purple-400 font-bold">æœ€çµ‚å¿ƒæƒ…:</span> <span id="final-mood"></span>%</p>
                    <p><span class="text-cyan-400 font-bold">æœ€çµ‚æ‰‹æ©Ÿé›»é‡:</span> <span id="final-phone"></span>%</p>
                    <p><span class="text-green-400 font-bold">ç„¡ç·šé›»:</span> <span id="final-radio"></span></p>
                </div>

                <!-- V8-Fix: ç§»åˆ°ä¸Šæ–¹
                <div id="conclusion-feedback" class="text-lg mb-8 p-4 bg-gray-700 rounded-md text-left">
                </div>
                -->
                
                <button id="reset-button" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition duration-300">
                    é‡æ–°æŒ‘æˆ°
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- V5 é›»å™¨è³‡æ–™ ---
            const applianceData = {
                high: [
                    { id: 'ih_stove', name: 'é›»ç£çˆ (ç…®ä¸€é¤)', cost: 3, type: 'consumable', effects: { fullness: +50, health: +10 } },
                    { id: 'heater', name: 'é›»æš–å™¨ (ä½¿ç”¨ 4 å°æ™‚)', cost: 3, type: 'consumable', effects: { health: +30, mood: +10 } }
                ],
                medium: [
                    { id: 'kettle', name: 'ç†±æ°´å£º (æ³¡èŒ¶/å’–å•¡/ç†±æ¹¯)', cost: 2, type: 'consumable', effects: { health: +20, mood: +10, fullness: +10 } },
                    { id: 'media_player', name: 'å¤šåª’é«”æ’­æ”¾å™¨ (å¨›æ¨‚ 2 å°æ™‚)', cost: 2, type: 'consumable', effects: { mood: +30 } }
                ],
                low: [
                    { id: 'phone', name: 'æ‰‹æ©Ÿ (å……é›»ä¸€æ¬¡)', cost: 1, type: 'consumable', effects: { phone: +100 } },
                    { id: 'led_light', name: 'LED éœ²ç‡Ÿç‡ˆ (é–‹å•Ÿ)', cost: 1, type: 'toggle', effects: { mood: +10 } },
                    { id: 'radio', name: 'ç„¡ç·šé›» (é–‹å•Ÿ)', cost: 1, type: 'toggle', effects: { mood: +10 } }
                ]
            };

            // --- éŠæˆ²ç‹€æ…‹ (V5) ---
            let gameState = {};

            const defaultGameState = {
                energy: 10,
                phase: 0, // 0: 07:00, 1: 12:00, 2: 18:00, 3: 21:00
                stats: {
                    fullness: 50,
                    health: 70,
                    mood: 50,
                    phone: 0
                },
                flags: {
                    led_light_on: false,
                    radio_on: false,
                    // ç”¨ä¾†è¿½è¹¤"æ‡²ç½°"æ˜¯å¦å·²è¢«æ‡‰ç”¨
                    darkness_penalty_applied: false, 
                    // V5: ç”¨ä¾†è¿½è¹¤ä½æº«æ‡²ç½°
                    low_temp_penalty_applied: false 
                }
            };

            const phaseDetails = [
                { time: "æ—©ä¸Š (07:00)", proceedText: "æ¨é€²åˆ° ä¸­åˆ (12:00)" },
                { time: "ä¸­åˆ (12:00)", proceedText: "æ¨é€²åˆ° å‚æ™š (18:00)" },
                { time: "å‚æ™š (18:00)", proceedText: "æ¨é€²åˆ° ç¡å‰ (21:00)" },
                { time: "ç¡å‰ (21:00)", proceedText: "ç¡è¦º (çµæŸé€™ä¸€å¤©)" }
            ];

            // --- DOM å…ƒç´  ---
            const screens = {
                intro: document.getElementById('intro-screen'),
                game: document.getElementById('game-screen'),
                conclusion: document.getElementById('conclusion-screen')
            };

            const buttons = {
                start: document.getElementById('start-button'),
                reset: document.getElementById('reset-button'),
                proceed: document.getElementById('proceed-button')
            };

            const ui = {
                energyDisplay: document.getElementById('energy-display'),
                energyCount: document.getElementById('energy-count'),
                phaseTitle: document.getElementById('phase-title'),
                scenarioReport: document.getElementById('scenario-report'),
                lists: {
                    high: document.getElementById('high-energy-list'),
                    medium: document.getElementById('medium-energy-list'),
                    low: document.getElementById('low-energy-list')
                },
                bars: {
                    fullness: document.getElementById('bar-fullness'),
                    health: document.getElementById('bar-health'),
                    mood: document.getElementById('bar-mood'),
                    phone: document.getElementById('bar-phone')
                },
                vals: {
                    fullness: document.getElementById('val-fullness'),
                    health: document.getElementById('val-health'),
                    mood: document.getElementById('val-mood'),
                    phone: document.getElementById('val-phone')
                },
                conclusion: {
                    title: document.getElementById('conclusion-title'),
                    stats: document.getElementById('conclusion-stats'),
                    feedback: document.getElementById('conclusion-feedback'),
                    finalFullness: document.getElementById('final-fullness'),
                    finalHealth: document.getElementById('final-health'),
                    finalMood: document.getElementById('final-mood'),
                    finalPhone: document.getElementById('final-phone'),
                    finalRadio: document.getElementById('final-radio')
                }
            };

            // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---

            function startGame() {
                screens.intro.classList.add('hidden');
                screens.game.classList.remove('hidden');
                
                // V5: ä½¿ç”¨æ·±æ‹·è²ä¾†é‡è¨­ç‹€æ…‹
                gameState = JSON.parse(JSON.stringify(defaultGameState));
                
                renderEnergyBlocks();
                renderAllApplianceCards();
                renderPhase(""); // åˆå§‹æƒ…å¢ƒå ±å‘Šç‚ºç©º

                // V6 Change: Scroll to top
                window.scrollTo({ top: 0, behavior: 'auto' });
            }

            buttons.start.addEventListener('click', startGame);
            buttons.reset.addEventListener('click', startGame);
            buttons.proceed.addEventListener('click', proceedToNextPhase);

            // --- æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ---

            // æ¸²æŸ“å–®å€‹æ™‚ç›¸
            function renderPhase(reportText) {
                const phase = phaseDetails[gameState.phase];
                
                ui.phaseTitle.textContent = phase.time;
                buttons.proceed.textContent = phase.proceedText;
                ui.scenarioReport.innerHTML = reportText || "è«‹é¸æ“‡ä½ è¦ä½¿ç”¨çš„é›»å™¨ã€‚";
                
                updateStatsUI();
                updateEnergyUI();
                updateAllCardButtons();
            }

            // æ¸²æŸ“èƒ½é‡æ ¼
            function renderEnergyBlocks() {
                ui.energyDisplay.innerHTML = '';
                for(let i = 0; i < 10; i++) {
                    const block = document.createElement('div');
                    block.id = `energy-block-${i}`;
                    block.className = 'energy-block h-6 rounded';
                    ui.energyDisplay.appendChild(block);
                }
            }

            // æ¸²æŸ“æ‰€æœ‰é›»å™¨å¡
            function renderAllApplianceCards() {
                ui.lists.high.innerHTML = '';
                ui.lists.medium.innerHTML = '';
                ui.lists.low.innerHTML = '';

                applianceData.high.forEach(app => ui.lists.high.appendChild(createCard(app, 'high')));
                applianceData.medium.forEach(app => ui.lists.medium.appendChild(createCard(app, 'medium')));
                applianceData.low.forEach(app => ui.lists.low.appendChild(createCard(app, 'low')));
            }

            // å‰µå»ºå–®å¼µé›»å™¨å¡
            function createCard(app, category) {
                const card = document.createElement('div');
                card.className = `bg-gray-800 p-4 rounded-lg shadow-lg card-category-${category} flex flex-col`;

                let effectsText = '';
                for (const [key, value] of Object.entries(app.effects)) {
                    const sign = value > 0 ? '+' : '';
                    let displayKey = '', colorClass = '';
                    switch (key) {
                        case 'fullness': displayKey = 'é£½è¶³åº¦'; colorClass = 'text-red-400'; break;
                        case 'health': displayKey = 'å¥åº·'; colorClass = 'text-blue-400'; break;
                        case 'mood': displayKey = 'å¿ƒæƒ…'; colorClass = 'text-purple-400'; break;
                        case 'phone': displayKey = 'æ‰‹æ©Ÿé›»é‡'; colorClass = 'text-cyan-400'; break;
                    }
                    effectsText += `<span class="${colorClass}">${displayKey}${sign}${value}%</span> `;
                }

                card.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-lg font-bold">${app.name}</h4>
                            <span class="text-sm text-gray-400">æ¶ˆè€— <span class="font-bold text-xl text-yellow-400">${app.cost}</span> æ ¼é›»</span>
                        </div>
                        <p class="text-xs text-gray-400 mb-3">${effectsText}</p>
                    </div>
                    <button data-id="${app.id}" data-cost="${app.cost}" data-type="${app.type}" class="select-btn w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        ä½¿ç”¨
                    </button>
                `;
                
                card.querySelector('.select-btn').addEventListener('click', () => useAppliance(app.id, category));
                return card;
            }

            // --- UI æ›´æ–°å‡½å¼ ---

            function updateStatsUI() {
                const stats = gameState.stats;
                stats.fullness = Math.min(100, Math.max(0, stats.fullness));
                stats.health = Math.min(100, Math.max(0, stats.health));
                stats.mood = Math.min(100, Math.max(0, stats.mood));
                stats.phone = Math.min(100, Math.max(0, stats.phone));

                ui.vals.fullness.textContent = `${stats.fullness}%`;
                ui.vals.health.textContent = `${stats.health}%`;
                ui.vals.mood.textContent = `${stats.mood}%`;
                ui.vals.phone.textContent = `${stats.phone}%`;

                ui.bars.fullness.style.width = `${stats.fullness}%`;
                ui.bars.health.style.width = `${stats.health}%`;
                ui.bars.mood.style.width = `${stats.mood}%`;
                ui.bars.phone.style.width = `${stats.phone}%`;
                
                // æ ¹æ“šæ•¸å€¼æ”¹è®Šé¡è‰²
                ui.bars.fullness.className = `survival-bar-fill rounded-full ${stats.fullness < 50 ? 'red' : 'green'}`;
                ui.bars.health.className = `survival-bar-fill rounded-full ${stats.health < 50 ? 'red' : 'blue'}`;
                ui.bars.mood.className = `survival-bar-fill rounded-full ${stats.mood < 50 ? 'red' : 'purple'}`;
            }

            function updateEnergyUI() {
                ui.energyCount.textContent = gameState.energy;
                if (gameState.energy <= 3) {
                    ui.energyCount.classList.remove('text-green-400');
                    ui.energyCount.classList.add('text-red-500');
                } else {
                    ui.energyCount.classList.add('text-green-400');
                    ui.energyCount.classList.remove('text-red-500');
                }

                for(let i = 0; i < 10; i++) {
                    const block = document.getElementById(`energy-block-${i}`);
                    if (i < gameState.energy) {
                        block.classList.add('full');
                        block.classList.remove('empty');
                    } else {
                        block.classList.add('empty');
                        block.classList.remove('full');
                    }
                }
            }

            function updateAllCardButtons() {
                document.querySelectorAll('.select-btn').forEach(btn => {
                    const cost = parseInt(btn.dataset.cost);
                    const type = btn.dataset.type;
                    const id = btn.dataset.id;
                    
                    let isDisabled = false;
                    let text = "ä½¿ç”¨";

                    // 1. æª¢æŸ¥æ˜¯å¦ç‚ºå·²é–‹å•Ÿçš„ 'toggle'
                    if (type === 'toggle' && gameState.flags[id + '_on']) {
                        isDisabled = true;
                        text = "å·²é–‹å•Ÿ";
                    }
                    // 2. æª¢æŸ¥é›»åŠ›æ˜¯å¦è¶³å¤ 
                    else if (cost > gameState.energy) {
                        isDisabled = true;
                        text = "é›»åŠ›ä¸è¶³";
                    }

                    // æ‡‰ç”¨ç‹€æ…‹
                    btn.disabled = isDisabled;
                    btn.textContent = text;
                    if (isDisabled) {
                        btn.classList.add('bg-gray-500', 'cursor-not-allowed');
                        btn.classList.remove('bg-green-600', 'hover:bg-green-500');
                        if (text === "é›»åŠ›ä¸è¶³") {
                            btn.classList.add('bg-red-700');
                            btn.classList.remove('bg-gray-500');
                        }
                    } else {
                        btn.classList.remove('bg-gray-500', 'bg-red-700', 'cursor-not-allowed');
                        btn.classList.add('bg-green-600', 'hover:bg-green-500');
                    }
                });
            }

            // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---

            // V5: ä½¿ç”¨é›»å™¨
            function useAppliance(id, category) {
                const allAppliances = [...applianceData.high, ...applianceData.medium, ...applianceData.low];
                const app = allAppliances.find(a => a.id === id);

                if (!app || gameState.energy < app.cost) return; // é‡è¤‡æª¢æŸ¥

                // æ‰£é™¤é›»åŠ›
                gameState.energy -= app.cost;

                // æ‡‰ç”¨æ•ˆæœ
                for (const [key, value] of Object.entries(app.effects)) {
                    gameState.stats[key] = Math.min(100, gameState.stats[key] + value);
                }

                // æ¨™è¨˜ 'toggle' é›»å™¨
                if (app.type === 'toggle') {
                    gameState.flags[id + '_on'] = true;
                }

                // æ›´æ–° UI
                updateEnergyUI();
                updateStatsUI();
                updateAllCardButtons();
            }

            // V5: æ¨é€²æ™‚ç›¸
            function proceedToNextPhase() {
                let report = []; // æƒ…å¢ƒå ±å‘Š

                // --- 1. è¢«å‹•æ‡²ç½°çµç®— (V5 é‚è¼¯) ---
                // çµç®—æ˜¯æ ¹æ“š *ä¸Šä¸€å€‹* æ™‚ç›¸çš„ç‹€æ…‹ä¾†æ±ºå®šçš„

                // V8-Fix: ç¡è¦º (Phase 3 -> 4) æ™‚ä¸æ‡‰æ¶ˆè€—é£½è¶³åº¦
                if (gameState.phase < 3) {
                    // V5: é£½è¶³åº¦è¢«å‹•æ¸›å°‘
                    gameState.stats.fullness = Math.max(0, gameState.stats.fullness - 30);
                    report.push("æ™‚é–“æµé€ï¼Œä½ æ¶ˆè€—äº†ä¸€äº›ç†±é‡ (é£½è¶³åº¦ -30%)ã€‚");

                    // V5: ä½é£½è¶³åº¦æ‡²ç½°
                    if (gameState.stats.fullness < 50) {
                        gameState.stats.health = Math.max(0, gameState.stats.health - 5);
                        gameState.stats.mood = Math.max(0, gameState.stats.mood - 5);
                        report.push(`<span class="text-red-400">ä½ çš„é£½è¶³åº¦éä½ (${gameState.stats.fullness}%)ï¼Œé£¢é¤“æ„Ÿè®“ä½ è™›å¼±ä¸”ç…©èº (å¥åº·-5%, å¿ƒæƒ…-5%)ã€‚</span>`);
                    }

                    // æ‰‹æ©Ÿè¢«å‹•è€—é›»
                    if (gameState.stats.phone > 0) {
                        gameState.stats.phone = Math.max(0, gameState.stats.phone - 50);
                        report.push("ä½ ä½¿ç”¨æ‰‹æ©ŸæŸ¥çœ‹äº†è³‡è¨Š (æ‰‹æ©Ÿé›»é‡ -50%)ã€‚");
                    }
                }

                // --- 2. æ ¹æ“šæ¨é€²åˆ°çš„ *æ–°æ™‚ç›¸* è§¸ç™¼ç‰¹å®šäº‹ä»¶ ---
                gameState.phase++;

                switch (gameState.phase) {
                    case 1: // æ¨é€²åˆ° ä¸­åˆ (12:00)
                        // æ—©ä¸Š 07:00 çš„çµç®— (å·²åœ¨ä¸Šé¢å®Œæˆ)
                        break;
                    
                    case 2: // æ¨é€²åˆ° å‚æ™š (18:00)
                        // ä¸­åˆ 12:00 çš„çµç®— (å·²åœ¨ä¸Šé¢å®Œæˆ)
                        report.push('<span class="text-yellow-400">å¤©é»‘äº†ã€‚</span>');
                        break;
                    
                    case 3: // æ¨é€²åˆ° ç¡å‰ (21:00)
                        // å‚æ™š 18:00 çš„çµç®—
                        // [å¤©é»‘æª¢æŸ¥]
                        if (!gameState.flags.led_light_on && !gameState.flags.darkness_penalty_applied) {
                            gameState.stats.mood = Math.max(0, gameState.stats.mood - 20);
                            report.push('<span class="text-purple-400">åœ¨é»‘æš—ä¸­åº¦éå‚æ™šè®“å¤§å®¶å¾ˆä¸å®‰ (å¿ƒæƒ… -20%)ã€‚</span>');
                            gameState.flags.darkness_penalty_applied = true; // åªæ‡²ç½°ä¸€æ¬¡
                        }
                        
                        // V7 Bug Fix: ç¢ºä¿ 21:00 çš„æç¤ºåœ¨é€™è£¡
                        report.push('<br>å¤œæ·±äº†ï¼Œ9Â°C çš„ç©ºæ°£åˆºéª¨ã€‚ä½ æº–å‚™ç¡è¦ºäº†ã€‚');
                        report.push('<span class="text-blue-400">(æç¤º) åœ¨é€™ç¨®ä½æº«ä¸‹ç¡è¦ºï¼Œä¸ä½¿ç”¨ç†±æº (é›»æš–å™¨/ç†±æ°´å£º) å°‡æœƒåš´é‡å½±éŸ¿ä½ çš„å¥åº·ã€‚</span>');
                        break;
                    
                    case 4: // æ¨é€²åˆ° ç¡è¦º (æ·±å¤œ 03:00)
                        // ç¡å‰ 21:00 çš„çµç®—
                        // [ä½æº«æ‡²ç½°]
                        const usedHeater = document.querySelector('.select-btn[data-id="heater"]').disabled; // ç°¡æ˜“æª¢æŸ¥ (ä¸å®Œç¾, ä½†å¯ç”¨)
                        const usedKettle = document.querySelector('.select-btn[data-id="kettle"]').disabled;
                        
                        // V7 Bug Fix: æ‡‰è©²æª¢æŸ¥æ˜¯å¦ *å‰›å‰›* ä½¿ç”¨äº†
                        // é€™è£¡ç°¡åŒ–é‚è¼¯ï¼šå¦‚æœå¥åº·åº¦ä½æ–¼æŸå€‹å€¼, è¦–ç‚ºå—å¯’
                        if (gameState.stats.health < 60 && !gameState.flags.low_temp_penalty_applied) {
                             gameState.stats.health = Math.max(0, gameState.stats.health - 15);
                             report.push('<span class="text-red-400">ä½ æ²’æœ‰è¶³å¤ çš„ç†±æºï¼Œåœ¨ 9Â°C ä½æº«ä¸‹ç¡å»ï¼Œå¥åº·åš´é‡ä¸‹é™ (å¥åº· -15%)ã€‚</span>');
                             gameState.flags.low_temp_penalty_applied = true;
                        }

                        // [æœ€çµ‚äº‹ä»¶: å…¥ä¾µè€…]
                        checkFinalEvent(report.join("<br>"));
                        return; // çµæŸéŠæˆ²ï¼Œä¸æ¸²æŸ“ä¸‹ä¸€æ™‚ç›¸
                }
                
                // --- 3. æª¢æŸ¥æ˜¯å¦æå‰å¤±æ•— ---
                if (gameState.stats.fullness <= 0) {
                    showConclusion(false, "ä½ å› é£½è¶³åº¦æ­¸é›¶è€Œæ˜å€’...<br>æŒ‘æˆ°å¤±æ•—ã€‚");
                    return;
                }
                if (gameState.stats.health <= 0) {
                    showConclusion(false, "ä½ å› å¥åº·æ­¸é›¶è€Œå€’ä¸‹...<br>æŒ‘æˆ°å¤±æ•—ã€‚");
                    return;
                }

                // --- 4. æ¸²æŸ“æ–°æ™‚ç›¸ ---
                renderPhase(report.join("<br>"));

                // V6 Change: Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            // V5: æœ€çµ‚äº‹ä»¶
            function checkFinalEvent(reportSummary) {
                let finalReport = reportSummary;
                finalReport += "<br><br><strong class='text-2xl text-red-500'>(æ·±å¤œ 03:00) ç °ï¼å·¨éŸ¿å‚³ä¾†ï¼Œæœ‰å…¥ä¾µè€…ï¼ä½ å¿…é ˆç«‹åˆ»æ±‚æ•‘ï¼</strong><br><br>";

                const canCall = gameState.stats.phone > 0;
                const canRadio = gameState.flags.radio_on;

                if (canCall) {
                    finalReport += "<span class='text-green-400'>ä½ æŠ“èµ·æ‰‹æ©ŸæˆåŠŸæ’¥è™Ÿ... æ•‘æ´éšŠæ­£åœ¨è·¯ä¸Šï¼</span>";
                    showConclusion(true, finalReport);
                } else if (canRadio) {
                    finalReport += "<span class='text-green-400'>ç„¡ç·šé›»å‚³ä¾†äº†å›æ‡‰... æ•‘æ´éšŠè½åˆ°äº†ä½ çš„æ±‚æ•‘ï¼</span>";
                    showConclusion(true, finalReport);
                } else {
                    finalReport += "<span class='text-red-400'>ä½ çš„æ‰‹æ©Ÿä¸€ç‰‡æ¼†é»‘ï¼Œç„¡ç·šé›»ä¹Ÿéœæ‚„æ‚„ã€‚ä½ éŒ¯å¤±äº†å”¯ä¸€çš„æ±‚æ•‘æ©Ÿæœƒ...</span>";
                    showConclusion(false, finalReport);
                }
            }

            // V5: é¡¯ç¤ºç¸½çµç•«é¢
            function showConclusion(isSuccess, reason) {
                screens.game.classList.add('hidden');
                screens.conclusion.classList.remove('hidden');

                if (isSuccess) {
                    ui.conclusion.title.textContent = "â® æŒ‘æˆ°æˆåŠŸ â¯";
                    ui.conclusion.title.classList.remove('text-red-500');
                    ui.conclusion.title.classList.add('text-green-400');
                    // V-Fix (Bug): Use innerHTML to render line breaks
                    ui.conclusion.feedback.innerHTML = reason; 
                    ui.conclusion.feedback.classList.remove('text-red-400');
                    ui.conclusion.feedback.classList.add('text-green-400');
                } else {
                    ui.conclusion.title.textContent = "â® æŒ‘æˆ°å¤±æ•— â¯";
                    ui.conclusion.title.classList.remove('text-green-400');
                    ui.conclusion.title.classList.add('text-red-500');
                    // V-Fix (Bug): Use innerHTML to render line breaks
                    ui.conclusion.feedback.innerHTML = reason;
                    ui.conclusion.feedback.classList.remove('text-green-400');
                    ui.conclusion.feedback.classList.add('text-red-400');
                }

                ui.conclusion.stats.textContent = `ä½ ç¸½å…±æ¶ˆè€—äº† ${10 - gameState.energy} æ ¼é›»ï¼Œå‰©é¤˜ ${gameState.energy} æ ¼ã€‚`;
                
                // é¡¯ç¤ºæœ€çµ‚æ•¸å€¼
                ui.conclusion.finalFullness.textContent = gameState.stats.fullness;
                ui.conclusion.finalHealth.textContent = gameState.stats.health;
                ui.conclusion.finalMood.textContent = gameState.stats.mood;
                ui.conclusion.finalPhone.textContent = gameState.stats.phone;
                ui.conclusion.finalRadio.textContent = gameState.flags.radio_on ? "å·²é–‹å•Ÿ" : "æœªé–‹å•Ÿ";

                // V6 Change: Scroll to top
                window.scrollTo({ top: 0, behavior: 'auto' });
            }

        });
    </script>
</body>
</html>
