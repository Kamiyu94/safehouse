<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·ä¹‹å‘¼å¸ï¼šé›»åŠ›ç”Ÿå­˜æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .card-category-high { border-left: 4px solid #EF4444; /* red-500 */ }
        .card-category-medium { border-left: 4px solid #F59E0B; /* amber-500 */ }
        .card-category-low { border-left: 4px solid #22C55E; /* green-500 */ }

        .energy-block {
            transition: all 0.3s ease;
        }
        .energy-block.full {
            background-color: #22C55E; /* green-500 */
            box-shadow: 0 0 10px 0 #22C55E80;
        }
        .energy-block.empty {
            background-color: #374151; /* gray-700 */
        }

        /* Survival Bar styles */
        .survival-bar-bg {
            background-color: #374151; /* gray-700 */
        }
        .survival-bar-fill {
            height: 100%;
            transition: width 0.5s ease-in-out;
            text-align: right;
            padding-right: 4px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .survival-bar-fill.red { background-color: #EF4444; }
        .survival-bar-fill.yellow { background-color: #F59E0B; }
        .survival-bar-fill.green { background-color: #22C55E; }
        .survival-bar-fill.blue { background-color: #3B82F6; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div id="app-container" class="max-w-xl mx-auto">

        <!-- ç•«é¢ 1: æƒ…å¢ƒä»‹ç´¹ -->
        <div id="intro-screen" class="flex flex-col items-center justify-center min-h-[90vh] text-center">
            <header class="mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-yellow-400 mb-4">â® é›»åŠ›ç”Ÿå­˜æŒ‘æˆ° â¯</h1>
                <p class="text-xl md:text-2xl text-gray-300">9Â°C ä½æº«ç”Ÿå­˜</p>
            </header>
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full">
                <p class="text-lg text-left font-bold mb-4">æƒ…å¢ƒ (é–‹æˆ°ç¬¬ä¸ƒå¤©)ï¼š</p>
                <p class="text-base text-left text-gray-300 mb-4">
                    å¯’æµä¾†è¥²ï¼Œå®¤å¤– 9Â°Cã€‚ç³§é£Ÿå’Œæ°´é‚„å¤ ï¼Œä½†å·²æ–·é›»ã€‚
                    å¹¸å¥½ï¼Œä½ çš„è“„é›»æ± å……é£½äº† <span class="text-green-400 font-bold">10 æ ¼é›»</span>ã€‚
                </p>
                 <p class="text-base text-left text-gray-300 mb-6">
                    ç¾åœ¨æ˜¯æ—©ä¸Š 07:00ï¼Œä½ å‰›èµ·åºŠï¼Œç‹€æ…‹å¦‚ä¸‹...
                </p>
                
                <!-- åˆå§‹ç‹€æ…‹ -->
                <div class="space-y-3 mb-8">
                    <div class="flex items-center space-x-2">
                        <span class="text-red-400 font-bold w-16">é£½è¶³åº¦:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-5">
                            <div class="survival-bar-fill yellow" style="width: 50%;">50%</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-blue-400 font-bold w-16">å¥åº·:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-5">
                            <div class="survival-bar-fill blue" style="width: 70%;">70%</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-yellow-400 font-bold w-16">å¿ƒæƒ…:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-5">
                            <div class="survival-bar-fill yellow" style="width: 50%;">50%</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-green-400 font-bold w-16">æ‰‹æ©Ÿ:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-5">
                            <div class="survival-bar-fill red" style="width: 0%;">é—œæ©Ÿ</div>
                        </div>
                    </div>
                </div>

                <button id="start-button" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition duration-300">
                    é–‹å§‹ 24 å°æ™‚æŒ‘æˆ°
                </button>
            </div>
        </div>

        <!-- ç•«é¢ 2: éŠæˆ²ä¸»é«” -->
        <div id="game-screen" class="hidden">
            <header class="text-center mb-4">
                <h1 id="current-time" class="text-3xl font-bold text-yellow-400">ç¾åœ¨æ˜¯ 07:00</h1>
            </header>

            <!-- æƒ…å¢ƒå ±å‘Š (é—œéµåŠŸèƒ½) -->
            <div id="scenario-report" class="hidden bg-red-900 border-l-4 border-red-500 text-red-100 p-4 rounded-md mb-4 shadow-lg">
                <!-- JS æœƒåœ¨é€™è£¡æ’å…¥æƒ…å¢ƒå ±å‘Š -->
            </div>
            
            <!-- å³æ™‚åé¥‹è¨Šæ¯ -->
            <div id="feedback-message" class="hidden p-3 rounded-lg mb-4 shadow-lg text-base font-bold text-center">
                <!-- JS æœƒåœ¨é€™è£¡æ’å…¥å³æ™‚è¨Šæ¯ -->
            </div>

            <!-- ç”Ÿå­˜æ•¸å€¼ (éŠæˆ²ä¸­) -->
            <div id="survival-stats" class="grid grid-cols-2 gap-3 mb-6 bg-gray-800 p-4 rounded-lg shadow-md">
                <div class="flex items-center space-x-2">
                    <span class="text-red-400 font-bold w-12">é£½è¶³åº¦:</span>
                    <div class="flex-grow survival-bar-bg rounded-full h-4">
                        <div id="bar-hunger" class="survival-bar-fill red"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-blue-400 font-bold w-12">å¥åº·:</span>
                    <div class="flex-grow survival-bar-bg rounded-full h-4">
                        <div id="bar-health" class="survival-bar-fill blue"></div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-yellow-400 font-bold w-12">å¿ƒæƒ…:</span>
                    <div class="flex-grow survival-bar-bg rounded-full h-4">
                        <div id="bar-mood" class="survival-bar-fill yellow"></div>
                    </div>
                </div>
                 <div class="flex items-center space-x-2">
                    <span class="text-green-400 font-bold w-12">æ‰‹æ©Ÿ:</span>
                    <div class="flex-grow survival-bar-bg rounded-full h-4">
                        <div id="bar-phone" class="survival-bar-fill green"></div>
                    </div>
                </div>
            </div>

            <!-- é›»åŠ›ç‹€æ…‹ -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-bold mb-3 border-b border-gray-600 pb-2">è“„é›»æ± å­˜é‡</h2>
                <div id="energy-display" class="grid grid-cols-5 gap-2 mb-3">
                    <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆ 10 æ ¼é›» -->
                </div>
                <div class="text-center text-lg font-bold">
                    å‰©é¤˜é›»åŠ›ï¼š <span id="energy-count" class="text-green-400 text-2xl">10</span> / 10
                </div>
            </div>
            
            <!-- é›»å™¨åˆ—è¡¨ -->
            <div id="appliance-list" class="space-y-6">
                <h2 class="text-xl font-bold text-gray-300 mb-2 text-center">é¸æ“‡ä½ è¦ä½¿ç”¨çš„é›»å™¨ï¼š</h2>
                <!-- é«˜è€—èƒ½ -->
                <section>
                    <h3 class="text-xl font-bold text-red-500 mb-3 flex items-center">
                        <span class="text-2xl mr-2">ğŸ‘¹</span> é«˜è€—èƒ½
                    </h3>
                    <div id="high-energy-list" class="grid grid-cols-1 gap-4">
                        <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆå¡ç‰‡ -->
                    </div>
                </section>
                <!-- ä¸­è€—èƒ½ -->
                <section>
                    <h3 class="text-xl font-bold text-amber-500 mb-3 flex items-center">
                        <span class="text-2xl mr-2">ğŸŸ¡</span> ä¸­è€—èƒ½
                    </h3>
                    <div id="medium-energy-list" class="grid grid-cols-1 gap-4">
                        <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆå¡ç‰‡ -->
                    </div>
                </section>
                <!-- ä½è€—èƒ½ -->
                <section>
                    <h3 class="text-xl font-bold text-green-500 mb-3 flex items-center">
                        <span class="text-2xl mr-2">ğŸ’š</span> ç¶­ç”Ÿç´š
                    </h3>
                    <div id="low-energy-list" class="grid grid-cols-1 gap-4">
                        <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆå¡ç‰‡ -->
                    </div>
                </section>
            </div>

            <!-- æ¨é€²æŒ‰éˆ• -->
            <button id="proceed-button" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transition duration-300 mt-8 sticky bottom-4 z-10 opacity-95">
                æ¨é€²åˆ° ä¸­åˆ (12:00)
            </button>
        </div>

        <!-- ç•«é¢ 3: ç¸½çµå ±å‘Š -->
        <div id="conclusion-screen" class="hidden flex flex-col items-center justify-center min-h-[90vh] text-center">
            <header class="mb-8">
                <h1 id="conclusion-title" class="text-3xl md:text-4xl font-bold text-yellow-400 mb-4">â® è©¦ç…‰ç¸½çµ â¯</h1>
            </header>
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full">
                
                <div id="conclusion-feedback" class="text-xl font-bold mb-6 p-4 bg-gray-700 rounded-md">
                    <!-- JS æ’å…¥ä¸»è¦çµæœ -->
                </div>

                <p id="conclusion-stats" class="text-lg text-gray-300 mb-6"></p>

                <div id="conclusion-details" class="text-left text-base bg-gray-900 p-4 rounded-md mb-6 space-y-2">
                    <h4 class="text-lg font-bold text-white border-b border-gray-700 pb-2">æœ€çµ‚ç‹€æ…‹</h4>
                    <!-- JS æ’å…¥æœ€çµ‚æ•¸å€¼ -->
                </div>
                
                <div class="text-left text-lg bg-gray-900 p-4 rounded-md mb-8">
                    <p class="font-bold text-xl mb-3 text-white">ã€æœ€çµ‚å•Ÿç¤ºã€‘</p>
                    <p class="text-gray-300">è¨˜ä½ï¼Œç½é›£ç”Ÿå­˜ä¸­ï¼Œ<span class="text-yellow-400 font-bold">ç¬¬ä¸€å„ªå…ˆ</span>æ°¸é æ˜¯ï¼š</p>
                    <ul class="list-disc list-inside mt-2 text-green-400">
                        <li>é€šè¨Š (æ±‚æ•‘ã€å°å¤–è¯ç¹«)</li>
                        <li>ç…§æ˜ (ç¢ºä¿å®‰å…¨ã€è¡Œå‹•)</li>
                        <li>è³‡è¨Š (æŒæ¡ç‹€æ³ã€æ‡‰è®Š)</li>
                    </ul>
                    <p class="mt-3 text-gray-300">ä½ å¿…é ˆåœ¨ã€Œç”Ÿå­˜ã€èˆ‡ã€Œèˆ’é©ã€ä¹‹é–“åšå‡ºæ®˜é…·çš„é¸æ“‡ã€‚</p>
                </div>

                <button id="reset-button" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg text-xl shadow-lg transition duration-300">
                    é‡æ–°æŒ‘æˆ°
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- éŠæˆ²è³‡æ–™è¨­å®š ---

            const applianceData = {
                high: [
                    { id: 'stove', name: 'é›»ç£çˆ (ç…®ä¸€é¤)', cost: 3, effects: { hunger: +50, health: +10 } }, // V5 Change: cost 4 -> 3
                    { id: 'heater', name: 'é›»æš–å™¨ (ä½¿ç”¨ 4 å°æ™‚)', cost: 3, effects: { health: +30, mood: +10 } }
                ],
                medium: [
                    { id: 'kettle', name: 'ç†±æ°´å£º (æ³¡èŒ¶/å’–å•¡/ç†±æ¹¯)', cost: 2, effects: { health: +20, mood: +10, hunger: +10 } }, // V5 Change: added hunger +10
                    { id: 'media', name: 'å¤šåª’é«”æ’­æ”¾å™¨ (å¨›æ¨‚ 2 å°æ™‚)', cost: 2, effects: { mood: +30 } }
                ],
                low: [
                    { id: 'phone', name: 'æ‰‹æ©Ÿ (å……é›»ä¸€æ¬¡)', cost: 1, effects: { phone: 100 } }, // ç‰¹æ®Šè™•ç†
                    { id: 'led', name: 'LED éœ²ç‡Ÿç‡ˆ (é–‹å•Ÿ)', cost: 1, effects: { mood: +10 } },
                    { id: 'radio', name: 'ç„¡ç·šé›» (é–‹å•Ÿ)', cost: 1, effects: { mood: +10, radioOn: true } } // ç‰¹æ®Šè™•ç†
                ]
            };

            const phaseData = {
                1: { time: "07:00", buttonText: "æ¨é€²åˆ° ä¸­åˆ (12:00)" },
                2: { time: "12:00", buttonText: "æ¨é€²åˆ° å‚æ™š (18:00)" },
                3: { time: "18:00", buttonText: "æ¨é€²åˆ° ç¡å‰ (21:00)" },
                4: { time: "21:00", buttonText: "ç¡è¦º (çµæŸé€™ä¸€å¤©)" },
            };

            // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---

            let gameState;

            // --- DOM å…ƒç´  ---
            const screens = {
                intro: document.getElementById('intro-screen'),
                game: document.getElementById('game-screen'),
                conclusion: document.getElementById('conclusion-screen')
            };
            const buttons = {
                start: document.getElementById('start-button'),
                reset: document.getElementById('reset-button'),
                proceed: document.getElementById('proceed-button')
            };
            const ui = {
                currentTime: document.getElementById('current-time'),
                scenarioReport: document.getElementById('scenario-report'),
                feedbackMessage: document.getElementById('feedback-message'),
                energyDisplay: document.getElementById('energy-display'),
                energyCount: document.getElementById('energy-count'),
                lists: {
                    high: document.getElementById('high-energy-list'),
                    medium: document.getElementById('medium-energy-list'),
                    low: document.getElementById('low-energy-list'),
                },
                bars: {
                    hunger: document.getElementById('bar-hunger'),
                    health: document.getElementById('bar-health'),
                    mood: document.getElementById('bar-mood'),
                    phone: document.getElementById('bar-phone'),
                },
                conclusion: {
                    title: document.getElementById('conclusion-title'),
                    feedback: document.getElementById('conclusion-feedback'),
                    stats: document.getElementById('conclusion-stats'),
                    details: document.getElementById('conclusion-details'),
                }
            };

            // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---

            function init() {
                // é‡è¨­éŠæˆ²ç‹€æ…‹
                gameState = {
                    phase: 1,
                    time: "07:00",
                    energy: 10,
                    stats: {
                        hunger: 50,
                        health: 70,
                        mood: 50,
                        phone: 0,
                        radioOn: false,
                    },
                    applianceUsed: {
                        // V4 Change: Only track one-time use items
                        led: false,
                        radio: false,
                    },
                    failReason: ""
                };
                
                // é¡¯ç¤º/éš±è—ç•«é¢
                screens.intro.classList.remove('hidden');
                screens.game.classList.add('hidden');
                screens.conclusion.classList.add('hidden');

                // æ¸²æŸ“èƒ½é‡ç©æœ¨
                renderEnergyBlocks();
            }

            function startGame() {
                screens.intro.classList.add('hidden');
                screens.game.classList.remove('hidden');
                renderPhase(""); // åˆå§‹æƒ…å¢ƒå ±å‘Šç‚ºç©º

                // V6 Change: Scroll to top
                window.scrollTo({ top: 0, behavior: 'auto' });
            }

            buttons.start.addEventListener('click', startGame);
            buttons.reset.addEventListener('click', init);
            buttons.proceed.addEventListener('click', proceedToNextPhase);

            // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---

            function proceedToNextPhase() {
                let report = []; // æƒ…å¢ƒå ±å‘Š
                let currentPhase = gameState.phase;
                let failed = false;

                // 1. çµç®—ä¸Šå€‹æ™‚æ®µçš„ã€Œè¢«å‹•æ‡²ç½°ã€
                switch (currentPhase) {
                    case 1: // 07:00 -> 12:00
                        // V5 Change: Passive fullness reduction (-30%) and penalty check
                        gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 30);
                        report.push(`... (æ™‚é–“æµé€) ... ä½ çš„è‚šå­é–‹å§‹å«äº† (é£½è¶³åº¦ -30%)ã€‚`);
                        if (gameState.stats.hunger < 50) {
                            gameState.stats.health = Math.max(0, gameState.stats.health - 5);
                            gameState.stats.mood = Math.max(0, gameState.stats.mood - 5);
                            report.push("ğŸ”´ é£½è¶³åº¦éä½ï¼Œä½ æ„Ÿåˆ°è™›å¼±ä¸”ç…©èº (å¥åº·-5%, å¿ƒæƒ…-5%)ã€‚");
                        }

                        if (gameState.stats.phone > 0) {
                            gameState.stats.phone = Math.max(0, gameState.stats.phone - 50);
                            report.push("ğŸ“± ä½ æ—©ä¸Šç”¨æ‰‹æ©ŸæŸ¥çœ‹äº†æ–°èï¼Œæ¶ˆè€—äº† 50% é›»åŠ›ã€‚");
                            if (gameState.stats.phone == 0) report.push("æ‰‹æ©Ÿæ²’é›»äº†ï¼");
                        }
                        break;
                    case 2: // 12:00 -> 18:00
                        // V5 Change: Passive fullness reduction (-30%) and penalty check
                        gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 30);
                        if (gameState.stats.hunger <= 0) {
                            report.push("ğŸš¨ ä½ å› ç‚ºéåº¦é£¢é¤“è€Œæ˜å€’äº†ï¼ (é£½è¶³åº¦ -30%)");
                        } else {
                            report.push(`... (æ™‚é–“æµé€) ... é£¢é¤“æ„Ÿè¶Šä¾†è¶Šå¼·çƒˆ (é£½è¶³åº¦ -30%)ã€‚`);
                            if (gameState.stats.hunger < 50) {
                                gameState.stats.health = Math.max(0, gameState.stats.health - 5);
                                gameState.stats.mood = Math.max(0, gameState.stats.mood - 5);
                                report.push("ğŸ”´ é£½è¶³åº¦éä½ï¼Œä½ æ„Ÿåˆ°è™›å¼±ä¸”ç…©èº (å¥åº·-5%, å¿ƒæƒ…-5%)ã€‚");
                            }
                        }
                        
                        if (gameState.stats.phone > 0) {
                            gameState.stats.phone = Math.max(0, gameState.stats.phone - 50);
                            report.push("ğŸ“± ä½ ä¸‹åˆåˆç”¨äº†æ‰‹æ©Ÿï¼Œæ¶ˆè€— 50% é›»åŠ›ã€‚");
                            if (gameState.stats.phone == 0) report.push("æ‰‹æ©Ÿæ²’é›»äº†ï¼");
                        }
                        // V5 Change: Passive fullness reduction (-30%) and penalty check
                        gameState.stats.hunger = Math.max(0, gameState.stats.hunger - 30);
                        if (gameState.stats.hunger <= 0) {
                            report.push("ğŸš¨ ä½ å› ç‚ºéåº¦é£¢é¤“è€Œæ˜å€’äº†ï¼ (é£½è¶³åº¦ -30%)");
                        } else {
                            report.push(`... (æ™‚é–“æµé€) ... ä½ æ„Ÿåˆ°éå¸¸é£¢é¤“ (é£½è¶³åº¦ -30%)ã€‚`);
                            if (gameState.stats.hunger < 50) {
                                gameState.stats.health = Math.max(0, gameState.stats.health - 5);
                                gameState.stats.mood = Math.max(0, gameState.stats.mood - 5);
                                report.push("ğŸ”´ é£½è¶³åº¦éä½ï¼Œä½ æ„Ÿåˆ°è™›å¼±ä¸”ç…©èº (å¥åº·-5%, å¿ƒæƒ…-5%)ã€‚");
                            }
                        }
                        
                        // V5 Change: Add 21:00 time prompt
                        report.push("<br>---<br>ğŸŒƒ å¤œæ·±äº†ï¼Œ9Â°C çš„ç©ºæ°£åˆºéª¨ã€‚ä½ æº–å‚™ç¡è¦ºäº†ã€‚");
                        report.push("ğŸ”µ (æç¤º) åœ¨é€™ç¨®ä½æº«ä¸‹ç¡è¦ºï¼Œä¸ä½¿ç”¨ç†±æº (é›»æš–å™¨/ç†±æ°´å£º) å°‡æœƒåš´é‡å½±éŸ¿ä½ çš„å¥åº·ã€‚");
                        break;
                    case 4: // 21:00 -> 03:00 (çµç®—)
                        endGame();
                        return;
                }

                // 2. æª¢æŸ¥æ˜¯å¦å› æ‡²ç½°è€Œå¤±æ•—
                failed = checkFailureConditions();
                if (failed) {
                    showConclusion(false, gameState.failReason);
                    return;
                }

                // 3. æ¨é€²æ™‚ç›¸
                gameState.phase++;
                gameState.time = phaseData[gameState.phase].time;

                // 4. æ¸²æŸ“æ–°æ™‚ç›¸
                renderPhase(report.join("<br>"));

                // V6 Change: Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function useAppliance(id, category) {
                const app = applianceData[category].find(a => a.id === id);
                if (!app) return;

                // V4 Change: Check for one-time use appliances (led, radio)
                const isOneTimeUse = (app.id === 'led' || app.id === 'radio');
                if (isOneTimeUse && gameState.applianceUsed[id]) {
                    showMessage("ä½ å·²ç¶“é–‹å•Ÿéé€™å€‹é›»å™¨äº†ã€‚", "info");
                    return;
                }

                // æª¢æŸ¥é›»åŠ›
                if (gameState.energy < app.cost) {
                    showMessage("é›»åŠ›ä¸è¶³ï¼", "error");
                    return;
                }

                // æ¶ˆè€—é›»åŠ›
                gameState.energy -= app.cost;

                // æ‡‰ç”¨æ•ˆæœ
                for (const [key, value] of Object.entries(app.effects)) {
                    if (key === 'radioOn') {
                        gameState.stats.radioOn = true;
                    } else if (key === 'phone') {
                        gameState.stats.phone = 100; // å……åˆ°é£½
                    } else {
                        gameState.stats[key] = Math.min(100, gameState.stats[key] + value);
                    }
                }

                // V4 Change: Mark one-time use appliances
                if (isOneTimeUse) {
                    gameState.applianceUsed[id] = true;
                }
                
                showMessage(`ä½ ä½¿ç”¨äº†ã€Œ${app.name}ã€ï¼Œæ¶ˆè€— ${app.cost} æ ¼é›»ã€‚`, "success");

                // ç«‹å³æ›´æ–° UI
                updateStatsUI();
                updateEnergyUI();
                renderAppliances(); // é‡ç¹ªæŒ‰éˆ•ç‹€æ…‹
            }

            function checkFailureConditions() {
                if (gameState.stats.hunger <= 0) {
                    gameState.failReason = "ä½ åœ¨å…¥ä¾µè€…åˆ°ä¾†å‰ï¼Œå°±å› ç‚ºéåº¦é£¢é¤“è€Œæ˜å€’äº†...";
                    return true;
                }
                if (gameState.stats.health <= 0) {
                    gameState.failReason = "ä½ åœ¨å…¥ä¾µè€…åˆ°ä¾†å‰ï¼Œå°±å› ç‚ºå¤±æº«æˆ–è™›å¼±è€Œæ˜å€’äº†...";
                    return true;
                }
                return false;
            }

            function endGame() {
                // 1. ç¡å‰æœ€å¾Œçš„å¥åº·æª¢æŸ¥ (9Â°C ä½æº«)
                if (!gameState.applianceUsed.heater && !gameState.applianceUsed.kettle) {
                    gameState.stats.health = Math.max(0, gameState.stats.health - 30);
                } else if (!gameState.applianceUsed.heater) {
                     gameState.stats.health = Math.max(0, gameState.stats.health - 15); // V5: Added penalty for only kettle
                }

                if (checkFailureConditions()) {
                    showConclusion(false, gameState.failReason);
                    return;
                }

                // 2. é—œéµäº‹ä»¶ï¼šå…¥ä¾µè€… (V5 Storyline)
                const rescued = gameState.stats.phone > 0 || gameState.stats.radioOn;
                let storyline = "(æ·±å¤œ 03:00) ç °ï¼å·¨éŸ¿å‚³ä¾†ï¼Œæœ‰å…¥ä¾µè€…ï¼ä½ å¿…é ˆç«‹åˆ»æ±‚æ•‘ï¼<br><br>";

                if (rescued) {
                    if (gameState.stats.phone > 0) {
                        storyline += "ä½ æŠ“èµ·æ‰‹æ©ŸæˆåŠŸæ’¥è™Ÿ... æ•‘æ´éšŠæ­£åœ¨è·¯ä¸Šï¼";
                    } else { // radioOn must be true
                        storyline += "ä½ æ‰“é–‹ç„¡ç·šé›»... å¦ä¸€ç«¯å‚³ä¾†äº†å›æ‡‰ï¼ æ•‘æ´éšŠæ­£åœ¨è·¯ä¸Šï¼";
                    }
                    showConclusion(true, storyline);
                } else {
                    storyline += "ä½ çš„æ‰‹æ©Ÿä¸€ç‰‡æ¼†é»‘ï¼Œç„¡ç·šé›»ä¹Ÿéœæ‚„æ‚„ã€‚ä½ éŒ¯å¤±äº†å”¯ä¸€çš„æ±‚æ•‘æ©Ÿæœƒ...";
                    showConclusion(false, storyline);
                }
            }

            // --- UI æ¸²æŸ“å‡½å¼ ---

            function renderPhase(reportText) {
                // æ›´æ–°æ™‚é–“
                ui.currentTime.textContent = `ç¾åœ¨æ˜¯ ${gameState.time}`;
                // *** FIX: Use buttons.proceed instead of ui.proceedButton ***
                buttons.proceed.textContent = phaseData[gameState.phase].buttonText;

                // é¡¯ç¤ºæƒ…å¢ƒå ±å‘Š
                if (reportText) {
                    ui.scenarioReport.innerHTML = reportText;
                    ui.scenarioReport.classList.remove('hidden');
                } else {
                    ui.scenarioReport.classList.add('hidden');
                }

                // æ›´æ–°æ‰€æœ‰ UI å…ƒç´ 
                updateStatsUI();
                updateEnergyUI();
                renderAppliances();
            }
            
            function renderAppliances() {
                // æ¸…ç©ºåˆ—è¡¨
                ui.lists.high.innerHTML = '';
                ui.lists.medium.innerHTML = '';
                ui.lists.low.innerHTML = '';

                // éæ­·ä¸‰ç¨®åˆ—è¡¨
                for (const category in applianceData) {
                    applianceData[category].forEach(app => {
                        const listEl = ui.lists[category];
                        const card = document.createElement('div');
                        card.className = `bg-gray-800 p-4 rounded-lg shadow-lg card-category-${category} flex justify-between items-center`;

                        let effectsText = '';
                        for (const [key, value] of Object.entries(app.effects)) {
                             effectsText += `${keyToText(key)} ${value > 0 ? '+' : ''}${value}${keyToUnit(key)} `;
                        }

                        let buttonDisabled = false;
                        let buttonText = "ä½¿ç”¨";

                        // V4 Change: Update button logic for reusable items
                        const isOneTimeUse = (app.id === 'led' || app.id === 'radio');
                        if (isOneTimeUse && gameState.applianceUsed[app.id]) {
                            buttonDisabled = true;
                            buttonText = "å·²é–‹å•Ÿ";
                        } else if (gameState.energy < app.cost) {
                            buttonDisabled = true;
                            buttonText = "é›»åŠ›ä¸è¶³";
                        } else if (app.id === 'phone' && gameState.stats.phone === 100) {
                            buttonDisabled = true;
                            buttonText = "å·²å……é£½";
                        } else if (app.id === 'phone') {
                            buttonText = "å……é›»";
                        } else if (isOneTimeUse) { // V4 Add
                            buttonText = "é–‹å•Ÿ";
                        }

                        card.innerHTML = `
                            <div>
                                <h4 class="text-lg font-bold">${app.name}</h4>
                                <p class="text-sm text-gray-400">æ•ˆæœ: ${effectsText}</p>
                            </div>
                            <button data-id="${app.id}" data-category="${category}" class="select-btn w-24 text-center bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-md transition duration-300 ${buttonDisabled ? 'bg-gray-500 cursor-not-allowed hover:bg-gray-500' : ''}" ${buttonDisabled ? 'disabled' : ''}>
                                ${buttonText} (${app.cost} æ ¼)
                            </button>
                        `;
                        listEl.appendChild(card);
                    });
                }
            }

            // ç¶å®šé›»å™¨æŒ‰éˆ•äº‹ä»¶ (äº‹ä»¶å§”æ´¾)
            document.getElementById('appliance-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('select-btn')) {
                    const id = e.target.dataset.id;
                    const category = e.target.dataset.category;
                    useAppliance(id, category);
                }
            });

            function updateStatsUI() {
                for (const [key, barEl] of Object.entries(ui.bars)) {
                    const value = gameState.stats[key];
                    let text = `${value}%`;
                    let colorClass = 'green';

                    if (key === 'phone') {
                        text = value > 0 ? `${value}%` : "é—œæ©Ÿ";
                    } else if (value <= 25) {
                        colorClass = 'red';
                    } else if (value <= 50) {
                        colorClass = 'yellow';
                    } else if (key === 'health') {
                        colorClass = 'blue';
                    }
                    
                    barEl.style.width = `${value}%`;
                    barEl.textContent = text;
                    barEl.className = `survival-bar-fill ${colorClass} rounded-full`;
                }
            }

            function updateEnergyUI() {
                ui.energyCount.textContent = gameState.energy;
                for (let i = 0; i < 10; i++) {
                    const block = document.getElementById(`energy-block-${i}`);
                    if (i < gameState.energy) {
                        block.classList.add('full');
                        block.classList.remove('empty');
                    } else {
                        block.classList.add('empty');
                        block.classList.remove('full');
                    }
                }
                if (gameState.energy <= 3) {
                    ui.energyCount.classList.add('text-red-500');
                    ui.energyCount.classList.remove('text-green-400');
                } else {
                    ui.energyCount.classList.add('text-green-400');
                    ui.energyCount.classList.remove('text-red-500');
                }
            }
            
            function renderEnergyBlocks() {
                ui.energyDisplay.innerHTML = '';
                for (let i = 0; i < 10; i++) {
                    const block = document.createElement('div');
                    block.id = `energy-block-${i}`;
                    block.className = 'energy-block h-6 rounded';
                    ui.energyDisplay.appendChild(block);
                }
            }

            function showMessage(message, type) {
                ui.feedbackMessage.textContent = message;
                ui.feedbackMessage.classList.remove('hidden', 'bg-red-600', 'bg-yellow-600', 'bg-green-600', 'bg-blue-600', 'opacity-0');
                
                let colorClass = 'bg-blue-600';
                if (type === 'error') colorClass = 'bg-red-600';
                else if (type === 'warning') colorClass = 'bg-yellow-600 text-gray-900';
                else if (type === 'success') colorClass = 'bg-green-600';
                
                ui.feedbackMessage.classList.add(colorClass);
                
                setTimeout(() => {
                    ui.feedbackMessage.classList.add('opacity-0');
                    setTimeout(() => ui.feedbackMessage.classList.add('hidden'), 500);
                }, 3000);
            }

            function showConclusion(isSuccess, reason) {
                screens.game.classList.add('hidden');
                screens.conclusion.classList.remove('hidden');

                if (isSuccess) {
                    ui.conclusion.title.textContent = "â® æŒ‘æˆ°æˆåŠŸ â¯";
                    ui.conclusion.title.classList.remove('text-red-500');
                    ui.conclusion.title.classList.add('text-green-400');
                    // V-Fix: Use innerHTML to render line breaks
                    ui.conclusion.feedback.innerHTML = reason; 
                    ui.conclusion.feedback.classList.remove('text-red-400');
                    ui.conclusion.feedback.classList.add('text-green-400');
                } else {
                    ui.conclusion.title.textContent = "â® æŒ‘æˆ°å¤±æ•— â¯";
                    ui.conclusion.title.classList.remove('text-green-400');
                    ui.conclusion.title.classList.add('text-red-500');
                    // V-Fix: Use innerHTML to render line breaks
                    ui.conclusion.feedback.innerHTML = reason;
                    ui.conclusion.feedback.classList.remove('text-green-400');
                    ui.conclusion.feedback.classList.add('text-red-400');
                }

                ui.conclusion.stats.textContent = `ä½ ç¸½å…±æ¶ˆè€—äº† ${10 - gameState.energy} æ ¼é›»ï¼Œå‰©é¤˜ ${gameState.energy} æ ¼ã€‚`;
                
                ui.conclusion.details.innerHTML = `
                    <h4 class="text-lg font-bold text-white border-b border-gray-700 pb-2">æœ€çµ‚ç‹€æ…‹</h4>
                    <p><span class="text-red-400 font-bold">é£½è¶³åº¦:</span> ${gameState.stats.hunger}%</p>
                    <p><span class="text-blue-400 font-bold">å¥åº·:</span> ${gameState.stats.health}%</p>
                    <p><span class="text-yellow-400 font-bold">å¿ƒæƒ…:</span> ${gameState.stats.mood}%</p>
                    <p><span class="text-green-400 font-bold">æ‰‹æ©Ÿ:</span> ${gameState.stats.phone}%</p>
                    <p><span class="text-green-400 font-bold">ç„¡ç·šé›»:</span> ${gameState.stats.radioOn ? "é–‹å•Ÿ" : "é—œé–‰"}</p>
                `;
            }

            // --- Helper å‡½å¼ ---
            function keyToText(key) {
                switch(key) {
                    case 'hunger': return 'é£½è¶³åº¦'; // V5 Change
                    case 'health': return 'å¥åº·';
                    case 'mood': return 'å¿ƒæƒ…';
                    case 'phone': return 'æ‰‹æ©Ÿ';
                    case 'radioOn': return 'ç„¡ç·šé›»';
                    default: return key;
                }
            }
            function keyToUnit(key) {
                switch(key) {
                    case 'phone': return '%';
                    case 'radioOn': return '';
                    default: return '%';
                }
            }
            
            // --- å•Ÿå‹•éŠæˆ² ---
            init();
        });
    </script>
</body>
</html>
