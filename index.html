<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›·ä¹‹å‘¼å¸ï¼šé›»åŠ›ç”Ÿå­˜æŒ‘æˆ°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #111827; /* gray-900 */
        }
        .card-category-high { border-left: 6px solid #EF4444; /* red-500 */ }
        .card-category-medium { border-left: 6px solid #F59E0B; /* amber-500 */ }
        .card-category-low { border-left: 6px solid #22C55E; /* green-500 */ }

        .energy-block {
            transition: all 0.3s ease;
        }
        .energy-block.full {
            background-color: #22C55E; /* green-500 */
            box-shadow: 0 0 10px 0 #22C55E80;
        }
        .energy-block.empty {
            background-color: #374151; /* gray-700 */
        }

        /* ç”Ÿå­˜æ•¸å€¼æ¢æ¨£å¼ */
        .survival-bar-bg {
            background-color: #374151; /* gray-700 */
        }
        .survival-bar-fill {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .survival-bar-fill.red { background-color: #EF4444; }
        .survival-bar-fill.yellow { background-color: #F59E0B; }
        .survival-bar-fill.green { background-color: #22C55E; }
        .survival-bar-fill.blue { background-color: #3B82F6; }
        .survival-bar-fill.purple { background-color: #8B5CF6; }
        .survival-bar-fill.cyan { background-color: #06B6D4; }

        /* ç¢ºä¿æµ®å‹•æ¨™é ­å’ŒæŒ‰éˆ•ä¸‹çš„å…§å®¹ä¸æœƒè¢«é®æ“‹ */
        #game-screen {
            padding-top: 240px; 
            padding-bottom: 140px; 
        }

        /* åœ–ç‰‡å®¹å™¨æ¨£å¼ */
        .story-image {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4">

    <div id="app-container" class="max-w-xl mx-auto">

        <!-- ç•«é¢ 1: æƒ…å¢ƒä»‹ç´¹ -->
        <div id="intro-screen" class="flex flex-col items-center justify-center min-h-[90vh] text-center">
            <header class="mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-yellow-400 mb-4">â® é›·ä¹‹å‘¼å¸ï¼šé›»åŠ›ç”Ÿå­˜æŒ‘æˆ° â¯</h1>
                <p class="text-2xl text-gray-300">è“„é›»æ± ä¸æ˜¯ç„¡é™çš„ï¼</p>
            </header>
            <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full">
                <!-- é–‹å ´åœ–ç‰‡ï¼šä¿®æ­£ onerror é‚è¼¯ -->
                <img src="images/morning_cold.jpg" 
                     onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1477601263545-51d103b72cb8?auto=format&fit=crop&w=800&q=80';" 
                     class="w-full h-56 object-cover rounded-md mb-6 opacity-90" 
                     alt="å¯’å†·çš„çª—æˆ¶">
                <p class="text-xl font-bold mb-4">(åš´è‚…åœ°) è©¦ç…‰é–‹å§‹ï¼</p>
                <p class="text-lg text-gray-300 mb-4 text-left leading-relaxed">
                    é–‹æˆ°ç¬¬ä¸ƒå¤©ï¼Œå¯’æµä¾†è¥²ï¼Œå®¤å¤– 9Â°Cã€‚ç³§é£Ÿå’Œæ°´é‚„å¤ ï¼Œä½†å·²æ–·é›»ã€‚
                    å¹¸å¥½ï¼Œä½ çš„è“„é›»æ± å……é£½äº† <span class="text-green-400 font-bold">10 æ ¼é›»</span>ã€‚
                </p>
                <p class="text-lg text-gray-300 mb-8 text-left leading-relaxed">
                    ç¾åœ¨æ˜¯æ—©ä¸Š 7:00ï¼Œä½ å‰›èµ·åºŠã€‚
                    <span class="text-purple-400 block mt-2">ä½ çš„ç²¾ç¥ç‹€æ…‹å¾ˆç·Šç¹ƒ (å¿ƒæƒ… 60%)ï¼Œä»»ä½•è² é¢ç‹€æ³éƒ½å¯èƒ½è®“ä½ å´©æ½°ã€‚</span>
                </p>
                <button id="start-button" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-5 px-6 rounded-lg text-2xl shadow-lg transition duration-300">
                    é–‹å§‹æŒ‘æˆ° (07:00)
                </button>
            </div>
        </div>

        <!-- ç•«é¢ 2: éŠæˆ²ä¸»é«” -->
        <div id="game-screen" class="hidden">
            
            <!-- æµ®å‹•ç‹€æ…‹åˆ— (é ‚éƒ¨) -->
            <div id="sticky-header" class="fixed top-0 left-0 right-0 bg-gray-900 shadow-2xl z-20 max-w-xl mx-auto p-4 border-b-2 border-gray-700">
                <!-- ç”Ÿå­˜æ•¸å€¼é¡¯ç¤º -->
                <div id="survival-stats" class="grid grid-cols-3 gap-2 mb-3 text-base font-bold">
                    <div class="flex items-center space-x-1">
                        <span class="text-red-400 w-12">é£½è¶³:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-4">
                            <div id="bar-fullness" class="survival-bar-fill red rounded-full" style="width: 50%;"></div>
                        </div>
                        <span id="val-fullness" class="w-10 text-right">50%</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="text-blue-400 w-12">å¥åº·:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-4">
                            <div id="bar-health" class="survival-bar-fill blue rounded-full" style="width: 70%;"></div>
                        </div>
                        <span id="val-health" class="w-10 text-right">70%</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="text-purple-400 w-12">å¿ƒæƒ…:</span>
                        <div class="flex-grow survival-bar-bg rounded-full h-4">
                            <div id="bar-mood" class="survival-bar-fill purple rounded-full" style="width: 60%;"></div>
                        </div>
                        <span id="val-mood" class="w-10 text-right">60%</span>
                    </div>
                </div>

                <!-- è³‡æºé¡¯ç¤ºåˆ— -->
                <div class="flex gap-4">
                    <!-- è“„é›»æ± å­˜é‡ -->
                    <div class="bg-gray-800 p-3 rounded-lg shadow-md flex-grow">
                        <h2 class="text-base font-bold mb-1 text-center text-gray-300">è“„é›»æ± å­˜é‡</h2>
                        <div id="energy-display" class="grid grid-cols-10 gap-1 mb-1 h-8">
                            <!-- JS æœƒåœ¨é€™è£¡ç”Ÿæˆ 10 æ ¼é›» -->
                        </div>
                        <div class="text-center text-xl font-bold leading-none mt-1">
                            <span id="energy-count" class="text-green-400 text-2xl">10</span> <span class="text-sm text-gray-400">/10 æ ¼</span>
                        </div>
                    </div>

                    <!-- æ‰‹æ©Ÿé›»é‡ (ç¨ç«‹åœ–ç¤º) -->
                    <div class="bg-gray-800 p-2 rounded-lg shadow-md w-24 flex flex-col items-center justify-center relative">
                        <div class="relative w-10 h-14 border-4 border-gray-500 bg-gray-900 rounded-lg overflow-hidden">
                            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-4 h-1.5 bg-gray-500 rounded-b-sm z-10"></div>
                            <div id="phone-battery-bar" class="absolute bottom-0 left-0 w-full bg-green-500 transition-all duration-500" style="height: 0%"></div>
                        </div>
                        <div class="text-sm font-bold text-green-400 mt-1">
                            <span id="val-phone">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- éŠæˆ²ä¸»è¦å…§å®¹ -->
            <main class="w-full">
                <header class="text-center mb-6">
                    <h1 id="phase-title" class="text-4xl font-bold text-yellow-400 drop-shadow-md"></h1>
                </header>

                <!-- æƒ…å¢ƒå ±å‘Š (å«åœ–ç‰‡) - ä¿®æ­£: ç§»é™¤ inline onerror ä»¥ä¿®å¾©é è¦½å•é¡Œ -->
                <div class="bg-gray-800 rounded-xl shadow-2xl mb-10 overflow-hidden border border-gray-600">
                    <img id="scenario-image" src="" class="story-image hidden" alt="æƒ…å¢ƒåœ–ç‰‡">
                    <div id="scenario-report" class="p-6 text-lg leading-loose text-gray-200">
                        <!-- JS æœƒåœ¨é€™è£¡æ’å…¥æƒ…å¢ƒå ±å‘Š -->
                    </div>
                </div>

                <!-- é›»å™¨å¡ç‰‡å€ -->
                <div id="appliance-list" class="space-y-8">
                    <h2 class="text-2xl font-bold text-gray-300 mb-6 text-center border-b border-gray-700 pb-2">é¸æ“‡ä½ è¦ä½¿ç”¨çš„é›»å™¨ï¼š</h2>
                    
                    <!-- é«˜è€—èƒ½ -->
                    <section>
                        <h3 class="text-2xl font-bold text-red-500 mb-4 flex items-center">
                            <span class="text-3xl mr-3">ğŸ‘¹</span> æ¯€æ»…ç´š (é«˜è€—èƒ½)
                        </h3>
                        <div id="high-energy-list" class="grid grid-cols-1 gap-6"></div>
                    </section>
                    
                    <!-- ä¸­è€—èƒ½ -->
                    <section>
                        <h3 class="text-2xl font-bold text-amber-500 mb-4 flex items-center">
                            <span class="text-3xl mr-3">ğŸŸ¡</span> æˆ°è¡“ç´š (ä¸­è€—èƒ½)
                        </h3>
                        <div id="medium-energy-list" class="grid grid-cols-1 gap-6"></div>
                    </section>

                    <!-- ä½è€—èƒ½ -->
                    <section>
                        <h3 class="text-2xl font-bold text-green-500 mb-4 flex items-center">
                            <span class="text-3xl mr-3">ğŸ’š</span> ç¶­ç”Ÿç´š (ä½è€—èƒ½)
                        </h3>
                        <div id="low-energy-list" class="grid grid-cols-1 gap-6"></div>
                    </section>
                </div>
            </main>

            <!-- æµ®å‹•æ¨é€²æŒ‰éˆ• -->
            <button id="proceed-button" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-5 px-6 rounded-t-xl text-2xl shadow-[0_-5px_15px_rgba(0,0,0,0.3)] transition duration-300 mt-8 fixed bottom-0 left-0 right-0 z-20 max-w-xl mx-auto opacity-95 border-t-2 border-blue-400">
                æ¨é€²åˆ° ä¸­åˆ (12:00)
            </button>
        </div>

        <!-- ç•«é¢ 3: ç¸½çµå ±å‘Š -->
        <div id="conclusion-screen" class="hidden flex flex-col items-center justify-center min-h-[90vh] text-center pt-20 pb-20">

            <div id="conclusion-feedback" class="text-xl mb-8 p-8 bg-gray-800 rounded-xl text-left w-full border-l-8 border-yellow-400 shadow-2xl leading-relaxed"></div>

            <header class="mb-8">
                <h1 id="conclusion-title" class="text-4xl md:text-5xl font-bold text-yellow-400 mb-4">â® è©¦ç…‰ç¸½çµ â¯</h1>
            </header>
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full">
                <p id="conclusion-stats" class="text-xl text-gray-300 mb-8 font-bold"></p>
                
                <div class="text-left text-lg bg-gray-900 p-6 rounded-lg mb-8 space-y-3">
                    <p><span class="text-red-400 font-bold">æœ€çµ‚é£½è¶³åº¦:</span> <span id="final-fullness"></span>%</p>
                    <p><span class="text-blue-400 font-bold">æœ€çµ‚å¥åº·:</span> <span id="final-health"></span>%</p>
                    <p><span class="text-purple-400 font-bold">æœ€çµ‚å¿ƒæƒ…:</span> <span id="final-mood"></span>%</p>
                    <p><span class="text-cyan-400 font-bold">æœ€çµ‚æ‰‹æ©Ÿé›»é‡:</span> <span id="final-phone"></span>%</p>
                    <p><span class="text-green-400 font-bold">ç„¡ç·šé›»:</span> <span id="final-radio"></span></p>
                </div>
                
                <button id="reset-button" class="w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-5 px-6 rounded-lg text-2xl shadow-lg transition duration-300">
                    é‡æ–°æŒ‘æˆ°
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- é›»å™¨è³‡æ–™ ---
            const applianceData = {
                high: [
                    { id: 'ih_stove', name: 'é›»ç£çˆ (ç…®ä¸€é¤)', cost: 3, type: 'consumable', desc: 'å¡«é£½è‚šå­æ˜¯ç”Ÿå­˜çš„åŸºç¤ã€‚', effects: { fullness: +50, health: +10 } },
                    { id: 'heater', name: 'é›»æš–å™¨ (ä½¿ç”¨ 4 å°æ™‚)', cost: 3, type: 'consumable', desc: 'å°æŠ— 9Â°C ä½æº«çš„é—œéµç†±æºã€‚', effects: { health: +30, mood: +10 } }
                ],
                medium: [
                    { id: 'kettle', name: 'ç†±æ°´å£º (æ³¡èŒ¶/å’–å•¡/ç†±æ¹¯)', cost: 2, type: 'consumable', desc: 'æš–èº«åˆæš–å¿ƒï¼Œå°å¹…è£œå……ç†±é‡ã€‚', effects: { health: +20, mood: +10, fullness: +10 } },
                    { id: 'media_player', name: 'å¤šåª’é«”æ’­æ”¾å™¨ (å¨›æ¨‚ 2 å°æ™‚)', cost: 2, type: 'consumable', desc: 'é©åº¦å¨›æ¨‚å¯ä»¥é¿å…å¿ƒç†å´©æ½°ã€‚', effects: { mood: +30 } }
                ],
                low: [
                    { 
                        id: 'phone', 
                        name: 'æ‰‹æ©Ÿ (å……é›»ä¸€æ¬¡)', 
                        cost: 1, 
                        type: 'consumable', 
                        desc: 'é€šè¨Šç”Ÿå‘½ç·šã€‚ç€è¦½è¨Šæ¯å¯ç«‹å³æå‡å¿ƒæƒ…ã€‚', 
                        effects: { phone: +100, mood: +15 } 
                    },
                    { id: 'led_light', name: 'LED éœ²ç‡Ÿç‡ˆ (é–‹å•Ÿå¸¸é§)', cost: 1, type: 'toggle', desc: 'åªéœ€é–‹å•Ÿä¸€æ¬¡ï¼Œå³å¯ç…§æ˜è‡³æ˜å¤©æ—©ä¸Šã€‚', effects: { mood: +10 } },
                    { id: 'radio', name: 'ç„¡ç·šé›» (é–‹å•Ÿç›£è½)', cost: 1, type: 'toggle', desc: 'é–‹å•Ÿå¾ŒæŒçºŒé‹ä½œï¼Œéš¨æ™‚æ¥æ”¶æ•‘æ´è¨Šè™Ÿã€‚', effects: { mood: +10 } }
                ]
            };

            // --- éŠæˆ²ç‹€æ…‹ ---
            let gameState = {};

            const defaultGameState = {
                energy: 10,
                phase: 0, // 0: 07:00, 1: 12:00, 2: 18:00, 3: 21:00
                stats: {
                    fullness: 50,
                    health: 70,
                    mood: 60,
                    phone: 0
                },
                flags: {
                    led_light_on: false,
                    radio_on: false,
                    darkness_penalty_applied: false,
                    low_temp_penalty_applied: false,
                    heater_used_tonight: false, 
                    kettle_used_tonight: false
                }
            };

            // è¨­å®šæœ¬åœ°åœ–ç‰‡è·¯å¾‘ (å«å‚™ç”¨ Unsplash é€£çµ)
            const phaseDetails = [
                { 
                    time: "æ—©ä¸Š (07:00)", 
                    proceedText: "æ¨é€²åˆ° ä¸­åˆ (12:00)", 
                    img: "images/morning_cold.jpg",
                    backupImg: "https://images.unsplash.com/photo-1477601263545-51d103b72cb8?auto=format&fit=crop&w=800&q=80"
                },
                { 
                    time: "ä¸­åˆ (12:00)", 
                    proceedText: "æ¨é€²åˆ° å‚æ™š (18:00)", 
                    img: "images/noon_hungry.jpg",
                    backupImg: "https://images.unsplash.com/photo-1518983830254-89a2069fa2f9?auto=format&fit=crop&w=800&q=80"
                },
                { 
                    time: "å‚æ™š (18:00)", 
                    proceedText: "æ¨é€²åˆ° ç¡å‰ (21:00)", 
                    img: "images/evening_dark.jpg",
                    backupImg: "https://images.unsplash.com/photo-1536746803623-14438dacec89?auto=format&fit=crop&w=800&q=80"
                },
                { 
                    time: "ç¡å‰ (21:00)", 
                    proceedText: "ç¡è¦º (çµæŸé€™ä¸€å¤©)", 
                    img: "images/night_freeze.jpg",
                    backupImg: "https://images.unsplash.com/photo-1504333638930-c8787321eee0?auto=format&fit=crop&w=800&q=80"
                }
            ];

            // --- DOM å…ƒç´  ---
            const screens = {
                intro: document.getElementById('intro-screen'),
                game: document.getElementById('game-screen'),
                conclusion: document.getElementById('conclusion-screen')
            };

            const buttons = {
                start: document.getElementById('start-button'),
                reset: document.getElementById('reset-button'),
                proceed: document.getElementById('proceed-button')
            };

            const ui = {
                energyDisplay: document.getElementById('energy-display'),
                energyCount: document.getElementById('energy-count'),
                phaseTitle: document.getElementById('phase-title'),
                scenarioReport: document.getElementById('scenario-report'),
                scenarioImage: document.getElementById('scenario-image'),
                lists: {
                    high: document.getElementById('high-energy-list'),
                    medium: document.getElementById('medium-energy-list'),
                    low: document.getElementById('low-energy-list')
                },
                bars: {
                    fullness: document.getElementById('bar-fullness'),
                    health: document.getElementById('bar-health'),
                    mood: document.getElementById('bar-mood'),
                    phone: document.getElementById('phone-battery-bar')
                },
                vals: {
                    fullness: document.getElementById('val-fullness'),
                    health: document.getElementById('val-health'),
                    mood: document.getElementById('val-mood'),
                    phone: document.getElementById('val-phone')
                },
                conclusion: {
                    title: document.getElementById('conclusion-title'),
                    stats: document.getElementById('conclusion-stats'),
                    feedback: document.getElementById('conclusion-feedback'),
                    finalFullness: document.getElementById('final-fullness'),
                    finalHealth: document.getElementById('final-health'),
                    finalMood: document.getElementById('final-mood'),
                    finalPhone: document.getElementById('final-phone'),
                    finalRadio: document.getElementById('final-radio')
                }
            };

            // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---

            function startGame() {
                screens.intro.classList.add('hidden');
                screens.conclusion.classList.add('hidden');
                screens.game.classList.remove('hidden');
                
                gameState = JSON.parse(JSON.stringify(defaultGameState));
                
                renderEnergyBlocks();
                renderAllApplianceCards();
                renderPhase(""); // åˆå§‹æƒ…å¢ƒå ±å‘Šç‚ºç©º

                window.scrollTo({ top: 0, behavior: 'auto' });
            }

            buttons.start.addEventListener('click', startGame);
            buttons.reset.addEventListener('click', startGame);
            buttons.proceed.addEventListener('click', proceedToNextPhase);

            // --- æ ¸å¿ƒæ¸²æŸ“å‡½å¼ ---

            function renderPhase(reportText) {
                const phase = phaseDetails[gameState.phase];
                
                ui.phaseTitle.textContent = phase.time;
                buttons.proceed.textContent = phase.proceedText;
                
                // é‡ç½®åœ–ç‰‡ç‹€æ…‹
                ui.scenarioImage.classList.add('hidden');
                
                // è¨­å®šè¼‰å…¥æˆåŠŸçš„å›èª¿
                ui.scenarioImage.onload = function() {
                    this.classList.remove('hidden');
                };
                
                // è¨­å®šè¼‰å…¥å¤±æ•—çš„å›èª¿ (è‡ªå‹•åˆ‡æ›å‚™ç”¨åœ–)
                ui.scenarioImage.onerror = function() {
                    this.onerror = null; // é˜²æ­¢ç„¡é™è¿´åœˆ
                    this.src = phase.backupImg;
                    this.classList.remove('hidden');
                };
                
                // é–‹å§‹è¼‰å…¥åœ–ç‰‡
                ui.scenarioImage.src = phase.img;
                
                ui.scenarioReport.innerHTML = reportText;
                
                updateStatsUI();
                updateEnergyUI();
                updateAllCardButtons();
            }

            function renderEnergyBlocks() {
                ui.energyDisplay.innerHTML = '';
                for(let i = 0; i < 10; i++) {
                    const block = document.createElement('div');
                    block.id = `energy-block-${i}`;
                    block.className = 'energy-block h-full rounded';
                    ui.energyDisplay.appendChild(block);
                }
            }

            function renderAllApplianceCards() {
                ui.lists.high.innerHTML = '';
                ui.lists.medium.innerHTML = '';
                ui.lists.low.innerHTML = '';

                applianceData.high.forEach(app => ui.lists.high.appendChild(createCard(app, 'high')));
                applianceData.medium.forEach(app => ui.lists.medium.appendChild(createCard(app, 'medium')));
                applianceData.low.forEach(app => ui.lists.low.appendChild(createCard(app, 'low')));
            }

            function createCard(app, category) {
                const card = document.createElement('div');
                card.className = `bg-gray-800 p-5 rounded-lg shadow-lg card-category-${category} flex flex-col border border-gray-700`;

                let effectsText = '';
                for (const [key, value] of Object.entries(app.effects)) {
                    const sign = value > 0 ? '+' : '';
                    let displayKey = '', colorClass = '';
                    switch (key) {
                        case 'fullness': displayKey = 'é£½è¶³åº¦'; colorClass = 'text-red-400'; break;
                        case 'health': displayKey = 'å¥åº·'; colorClass = 'text-blue-400'; break;
                        case 'mood': displayKey = 'å¿ƒæƒ…'; colorClass = 'text-purple-400'; break;
                        case 'phone': displayKey = 'æ‰‹æ©Ÿé›»é‡'; colorClass = 'text-cyan-400'; break;
                    }
                    effectsText += `<span class="${colorClass} font-bold text-xl mr-3 whitespace-nowrap">${displayKey}${sign}${value}%</span> `;
                }

                card.innerHTML = `
                    <div class="flex-grow mb-5">
                        <div class="flex justify-between items-start mb-3">
                            <h4 class="text-xl md:text-2xl font-bold text-white">${app.name}</h4>
                            <span class="text-base text-gray-300 whitespace-nowrap ml-2 bg-gray-900 px-2 py-1 rounded">æ¶ˆè€— <span class="font-bold text-xl text-yellow-400">${app.cost}</span> æ ¼</span>
                        </div>
                        <p class="text-lg text-gray-300 mb-3 leading-snug">${app.desc}</p>
                        <div class="mt-3 flex flex-wrap">${effectsText}</div>
                    </div>
                    <button data-id="${app.id}" data-cost="${app.cost}" data-type="${app.type}" class="select-btn w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-6 rounded-lg transition duration-300 text-xl shadow-md border-b-4 border-green-700 active:border-0 active:translate-y-1">
                        ä½¿ç”¨
                    </button>
                `;
                
                card.querySelector('.select-btn').addEventListener('click', () => useAppliance(app.id, category));
                return card;
            }

            // --- UI æ›´æ–°å‡½å¼ ---

            function updateStatsUI() {
                const stats = gameState.stats;
                for(let key in stats) stats[key] = Math.min(100, Math.max(0, stats[key]));

                ui.vals.fullness.textContent = `${stats.fullness}%`;
                ui.vals.health.textContent = `${stats.health}%`;
                ui.vals.mood.textContent = `${stats.mood}%`;
                ui.vals.phone.textContent = `${stats.phone}%`;

                ui.bars.fullness.style.width = `${stats.fullness}%`;
                ui.bars.health.style.width = `${stats.health}%`;
                ui.bars.mood.style.width = `${stats.mood}%`;
                ui.bars.phone.style.height = `${stats.phone}%`;
                
                ui.bars.fullness.className = `survival-bar-fill rounded-full ${stats.fullness < 50 ? 'red' : 'green'}`;
                ui.bars.health.className = `survival-bar-fill rounded-full ${stats.health < 50 ? 'red' : 'blue'}`;
                ui.bars.mood.className = `survival-bar-fill rounded-full ${stats.mood < 50 ? 'red' : 'purple'}`;
            }

            function updateEnergyUI() {
                ui.energyCount.textContent = gameState.energy;
                ui.energyCount.className = gameState.energy <= 3 ? 'text-red-500 text-2xl' : 'text-green-400 text-2xl';

                for(let i = 0; i < 10; i++) {
                    const block = document.getElementById(`energy-block-${i}`);
                    if (i < gameState.energy) {
                        block.classList.add('full');
                        block.classList.remove('empty');
                    } else {
                        block.classList.add('empty');
                        block.classList.remove('full');
                    }
                }
            }

            function updateAllCardButtons() {
                document.querySelectorAll('.select-btn').forEach(btn => {
                    const cost = parseInt(btn.dataset.cost);
                    const type = btn.dataset.type;
                    const id = btn.dataset.id;
                    
                    let isDisabled = false;
                    let text = "ä½¿ç”¨";

                    if (type === 'toggle' && gameState.flags[id + '_on']) {
                        isDisabled = true;
                        text = "å·²é–‹å•Ÿ";
                    } else if (cost > gameState.energy) {
                        isDisabled = true;
                        text = "é›»åŠ›ä¸è¶³";
                    }

                    btn.disabled = isDisabled;
                    btn.textContent = text;
                    
                    btn.className = "select-btn w-full font-bold py-4 px-6 rounded-lg transition duration-300 text-xl shadow-md border-b-4 active:border-0 active:translate-y-1";
                    
                    if (isDisabled) {
                        btn.classList.add('cursor-not-allowed', 'border-transparent');
                        if (text === "å·²é–‹å•Ÿ") {
                            btn.classList.add('bg-gray-600', 'text-gray-300');
                        } else { // é›»åŠ›ä¸è¶³
                            btn.classList.add('bg-red-900', 'text-red-200', 'opacity-60');
                        }
                    } else {
                        btn.classList.add('bg-green-600', 'hover:bg-green-500', 'text-white', 'border-green-700');
                    }
                });
            }

            // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---

            function useAppliance(id, category) {
                const allAppliances = [...applianceData.high, ...applianceData.medium, ...applianceData.low];
                const app = allAppliances.find(a => a.id === id);

                if (!app || gameState.energy < app.cost) return;

                gameState.energy -= app.cost;

                for (const [key, value] of Object.entries(app.effects)) {
                    gameState.stats[key] = Math.min(100, gameState.stats[key] + value);
                }

                if (app.type === 'toggle') {
                    gameState.flags[id + '_on'] = true;
                }

                if (gameState.phase === 3) {
                    if (id === 'heater') gameState.flags.heater_used_tonight = true;
                    if (id === 'kettle') gameState.flags.kettle_used_tonight = true;
                }

                updateEnergyUI();
                updateStatsUI();
                updateAllCardButtons();
            }

            // ç”¢ç”Ÿæƒ…å¢ƒæè¿°
            function generateStory(phase, passiveEffects) {
                let story = "";
                
                if (passiveEffects.length > 0) {
                    story += `<div class="mb-6 p-4 bg-gray-900 rounded border-l-8 border-red-500 text-base text-gray-200 shadow-inner">${passiveEffects.join("<br>")}</div>`;
                }

                if (phase === 1) { // 12:00
                    story += `<p class="mb-3">å¤ªé™½å‡åˆ°äº†é ­é ‚ï¼Œä½†æ°£æº«ä¾ç„¶å¾ˆä½ã€‚</p>`;
                    if (gameState.stats.fullness >= 50) {
                        story += `<p class="text-green-400">é›–ç„¶è‚šå­æ¶ˆåŒ–äº†ä¸€äº›ï¼Œä½†é«”åŠ›é‚„ç®—å……è¶³ã€‚</p>`;
                    } else if (gameState.stats.fullness < 40) {
                        story += `<p class="text-red-400">è‚šå­é–‹å§‹ç™¼å‡ºå·¨å¤§çš„å’•åš•è²ï¼Œé£¢é¤“æ„Ÿè¥²ä¾†...</p>`;
                    } else {
                        story += `<p class="text-gray-400">ä½ æ„Ÿåˆ°æœ‰äº›é¤“äº†ï¼Œä½†é‚„èƒ½å¿å—ã€‚</p>`;
                    }
                } else if (phase === 2) { // 18:00
                    story += `<p class="mb-3">å¤ªé™½ä¸‹å±±äº†ï¼Œå…‰ç·šæ­£å¿«é€Ÿæ¶ˆå¤±ï¼Œææ‡¼æ„Ÿéš¨è‘—é»‘æš—è¥²ä¾†ã€‚</p>`;
                    if (gameState.stats.phone > 20) {
                        story += `<p class="text-cyan-400">å¹¸å¥½æ‰‹æ©Ÿé‚„æœ‰é›»ï¼Œè¢å¹•çš„å¾®å…‰å¸¶ä¾†äº†ä¸€é»å®‰å…¨æ„Ÿã€‚</p>`;
                    } else {
                        story += `<p class="text-red-400">æ‰‹æ©Ÿè¢å¹•ä¸€ç‰‡æ¼†é»‘ï¼Œç„¡æ³•èˆ‡å¤–ç•Œè¯ç¹«è®“ä½ æ„Ÿåˆ°æ›´åŠ å­¤ç«‹ç„¡æ´ã€‚</p>`;
                    }
                } else if (phase === 3) { // 21:00
                    story += `<p class="mb-3">å¤œæ·±äº†ï¼Œé€™æ˜¯æœ€å±éšªçš„æ™‚åˆ»ã€‚æ°£æº«é™åˆ°äº†æœ€ä½é»ã€‚</p>`;
                    if (gameState.flags.led_light_on) {
                        story += `<p class="text-green-400 mb-3">éœ²ç‡Ÿç‡ˆæº«æš–çš„å…‰èŠ’ç…§äº®äº†æˆ¿é–“ï¼Œå¤§å®¶å¿ƒæƒ…å¹³éœè¨±å¤šã€‚</p>`;
                    } else {
                        story += `<p class="text-purple-400 mb-3">å››å‘¨ä¼¸æ‰‹ä¸è¦‹äº”æŒ‡ï¼Œé»‘æš—ä¸­å‚³ä¾†çš„ä»»ä½•è²éŸ³éƒ½è®“äººç¥ç¶“ç·Šç¹ƒã€‚</p>`;
                    }
                    story += `<p class="font-bold text-blue-400 border-t-2 border-gray-600 pt-4 mt-4 text-lg">(ç³»çµ±æç¤º) ç¡è¦ºæ™‚è‹¥æ²’æœ‰ç†±æºï¼Œæ¥µå¯èƒ½å°è‡´å‡å‚·æˆ–å¤±æº«ã€‚</p>`;
                }

                return story;
            }

            function proceedToNextPhase() {
                let passiveReports = []; 

                // ç¡è¦º (Phase 3 -> 4) æ™‚ä¸æ¶ˆè€—é£½è¶³åº¦
                if (gameState.phase < 3) {
                    // é£½è¶³åº¦èˆ‡å¥åº·æ‡²ç½°
                    gameState.stats.fullness = Math.max(0, gameState.stats.fullness - 30);
                    passiveReports.push("æ™‚é–“æµé€ï¼Œæ¶ˆè€—äº†ç†±é‡ (é£½è¶³åº¦ -30%)");

                    if (gameState.stats.fullness < 50) {
                        gameState.stats.health = Math.max(0, gameState.stats.health - 5);
                        gameState.stats.mood = Math.max(0, gameState.stats.mood - 5);
                        passiveReports.push("é£½è¶³åº¦éä½ï¼Œæ„Ÿåˆ°è™›å¼±ç…©èº (å¥åº·-5%, å¿ƒæƒ…-5%)");
                    }

                    // V7: æ‰‹æ©Ÿèˆ‡å¿ƒæƒ…é€£å‹•
                    if (gameState.stats.phone > 0) {
                        gameState.stats.phone = Math.max(0, gameState.stats.phone - 50);
                        passiveReports.push("å¾…æ©Ÿèˆ‡æŸ¥çœ‹è³‡è¨Šæ¶ˆè€—é›»åŠ› (æ‰‹æ©Ÿ -50%)");
                    } else {
                        gameState.stats.mood = Math.max(0, gameState.stats.mood - 20);
                        passiveReports.push("ç„¡æ³•èˆ‡å¤–ç•Œè¯ç¹«ï¼Œå­¤ç«‹æ„Ÿè®“ä½ å¿ƒæƒ…ä½è½ (å¿ƒæƒ… -20%)");
                    }
                }

                gameState.phase++;

                // V7: é»‘æš—æ‡²ç½°
                if ((gameState.phase === 2 || gameState.phase === 3) && !gameState.flags.led_light_on) {
                    gameState.stats.mood = Math.max(0, gameState.stats.mood - 15);
                    passiveReports.push("é»‘æš—çœ‹ä¸è¦‹å‘¨åœï¼Œææ‡¼æ„Ÿä¾µè•æ„å¿— (å¿ƒæƒ… -15%)");
                }

                // æ·±å¤œ 03:00 çµç®—
                if (gameState.phase === 4) { 
                    const hasHeater = gameState.flags.heater_used_tonight;
                    const hasKettle = gameState.flags.kettle_used_tonight;
                    let sleepReport = "";

                    if (!hasHeater && !hasKettle) {
                        gameState.stats.health = Math.max(0, gameState.stats.health - 30);
                        sleepReport = "<span class='text-red-500'>æ²’æœ‰ç†±æºï¼Œåš´é‡å‡å‚· (å¥åº· -30%)</span>";
                    } else if (!hasHeater && hasKettle) {
                        gameState.stats.health = Math.max(0, gameState.stats.health - 15);
                        sleepReport = "<span class='text-red-400'>åªæœ‰ç†±é£²ä¸å¤ ä¿æš–ï¼Œå—å¯’äº† (å¥åº· -15%)</span>";
                    } else {
                        sleepReport = "<span class='text-green-400'>å®¤å…§ä¿æŒæº«æš–ï¼Œå®‰ç©©å…¥ç¡ã€‚</span>";
                    }
                    
                    checkFinalEvent(sleepReport);
                    return;
                }
                
                // æª¢æŸ¥ææ—©å¤±æ•—
                if (gameState.stats.fullness <= 0 || gameState.stats.health <= 0 || gameState.stats.mood <= 0) {
                    let reason = "æŒ‘æˆ°å¤±æ•—ã€‚";
                    if (gameState.stats.fullness <= 0) reason = "ä½ å› é£½è¶³åº¦æ­¸é›¶è€Œæ˜å€’...<br>æŒ‘æˆ°å¤±æ•—ã€‚";
                    if (gameState.stats.health <= 0) reason = "ä½ å› å¥åº·æ­¸é›¶è€Œå€’ä¸‹...<br>æŒ‘æˆ°å¤±æ•—ã€‚";
                    if (gameState.stats.mood <= 0) reason = "ä½ å› ç²¾ç¥å´©æ½°è€Œæ”¾æ£„ç”Ÿå­˜...<br>æŒ‘æˆ°å¤±æ•—ã€‚";
                    
                    showConclusion(false, reason);
                    return;
                }

                const storyHTML = generateStory(gameState.phase, passiveReports);
                renderPhase(storyHTML);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            function checkFinalEvent(sleepReport) {
                let finalReport = "";
                finalReport += `<p class="mb-6 border-b-2 border-gray-600 pb-6 text-xl">${sleepReport}</p>`;
                
                ui.scenarioImage.src = "images/intruder_alert.jpg";
                // ä¿®æ­£ onerror
                ui.scenarioImage.onerror = function() {
                    this.onerror = null;
                    this.src = "https://images.unsplash.com/photo-1626672758949-540334017f95?auto=format&fit=crop&w=800&q=80";
                    this.classList.remove('hidden');
                };
                ui.scenarioImage.classList.remove('hidden');

                finalReport += "<strong class='text-3xl text-red-500 block mb-6'>(æ·±å¤œ 03:00) ç °ï¼å·¨éŸ¿å‚³ä¾†ï¼Œæœ‰å…¥ä¾µè€…ï¼ä½ å¿…é ˆç«‹åˆ»æ±‚æ•‘ï¼</strong>";

                if (gameState.stats.health <= 0) {
                     finalReport += "<p class='text-red-400 text-xl'>ä½†ä½ å› ç‚ºé«”åŠ›ä¸æ”¯/åš´é‡å‡å‚·ï¼Œå·²ç¶“æ²’æœ‰åŠ›æ°£æ±‚æ•‘äº†... (æŒ‘æˆ°å¤±æ•—)</p>";
                     showConclusion(false, finalReport);
                     return;
                }

                const canCall = gameState.stats.phone > 0;
                const canRadio = gameState.flags.radio_on;

                if (canCall) {
                    finalReport += "<p class='text-green-400 text-2xl font-bold'>ä½ æŠ“èµ·æ‰‹æ©ŸæˆåŠŸæ’¥è™Ÿ... æ•‘æ´éšŠæ­£åœ¨è·¯ä¸Šï¼</p>";
                    showConclusion(true, finalReport);
                } else if (canRadio) {
                    finalReport += "<p class='text-green-400 text-2xl font-bold'>ç„¡ç·šé›»å‚³ä¾†äº†å›æ‡‰... æ•‘æ´éšŠè½åˆ°äº†ä½ çš„æ±‚æ•‘ï¼</p>";
                    showConclusion(true, finalReport);
                } else {
                    finalReport += "<p class='text-red-400 text-2xl font-bold'>ä½ çš„æ‰‹æ©Ÿä¸€ç‰‡æ¼†é»‘ï¼Œç„¡ç·šé›»ä¹Ÿéœæ‚„æ‚„ã€‚ä½ éŒ¯å¤±äº†å”¯ä¸€çš„æ±‚æ•‘æ©Ÿæœƒ...</p>";
                    showConclusion(false, finalReport);
                }
            }

            function showConclusion(isSuccess, reason) {
                screens.game.classList.add('hidden');
                screens.conclusion.classList.remove('hidden');

                if (isSuccess) {
                    ui.conclusion.title.textContent = "â® æŒ‘æˆ°æˆåŠŸ â¯";
                    ui.conclusion.title.classList.remove('text-red-500');
                    ui.conclusion.title.classList.add('text-green-400');
                    ui.conclusion.feedback.innerHTML = reason; 
                    ui.conclusion.feedback.classList.remove('text-red-400', 'border-red-500');
                    ui.conclusion.feedback.classList.add('text-green-400', 'border-green-400');
                } else {
                    ui.conclusion.title.textContent = "â® æŒ‘æˆ°å¤±æ•— â¯";
                    ui.conclusion.title.classList.remove('text-green-400');
                    ui.conclusion.title.classList.add('text-red-500');
                    ui.conclusion.feedback.innerHTML = reason;
                    ui.conclusion.feedback.classList.remove('text-green-400', 'border-green-400');
                    ui.conclusion.feedback.classList.add('text-red-400', 'border-red-500');
                }

                ui.conclusion.stats.textContent = `ä½ ç¸½å…±æ¶ˆè€—äº† ${10 - gameState.energy} æ ¼é›»ï¼Œå‰©é¤˜ ${gameState.energy} æ ¼ã€‚`;
                
                ui.conclusion.finalFullness.textContent = gameState.stats.fullness;
                ui.conclusion.finalHealth.textContent = gameState.stats.health;
                ui.conclusion.finalMood.textContent = gameState.stats.mood;
                ui.conclusion.finalPhone.textContent = gameState.stats.phone;
                ui.conclusion.finalRadio.textContent = gameState.flags.radio_on ? "å·²é–‹å•Ÿ" : "æœªé–‹å•Ÿ";

                window.scrollTo({ top: 0, behavior: 'auto' });
            }
        });
    </script>
</body>
</html>
